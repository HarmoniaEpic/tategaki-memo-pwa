<!DOCTYPE html>
<!--
Á∏¶Êõ∏„Åç„É°„É¢„Ç¢„Éó„É™ v1.8.0
ÊïôËÇ≤ÁèæÂ†¥Âêë„ÅëÁ∏¶Êõ∏„Åç„ÉÜ„Ç≠„Çπ„Éà„Ç®„Éá„Ç£„ÇøÔºà„Éû„Éº„Ç´„ÉºÊ©üËÉΩ‰ªò„ÅçÔºâ

‰∏ªË¶ÅÊ©üËÉΩ:
- Á∏¶Êõ∏„Åç„ÉÜ„Ç≠„Çπ„ÉàÁ∑®ÈõÜ„Éª„É™„Ç¢„É´„Çø„Ç§„É†„Éó„É¨„Éì„É•„Éº
- „Éû„Éº„Ç´„ÉºÔºàËõçÂÖâ„Éö„É≥ÔºâÊ©üËÉΩÔºà5Ëâ≤ÔºãÊ∂à„Åó„Ç¥„É†Ôºâ
- SVG/PNG‰øùÂ≠ò„ÉªË™≠ËæºÔºàÈÄèÈÅéPNGÂØæÂøúÔºâ
- Âç∞Âà∑Ê©üËÉΩÔºàA4Á∏¶„Éª„Éö„Éº„Ç∏ÂàÜÂâ≤ÂØæÂøúÔºâ
- ÈªíÊùø„É¢„Éº„ÉâÔºà„ÉÅ„Éß„Éº„ÇØÈ¢®Ë°®Á§∫Ôºâ
- „É¨„Çπ„Éù„É≥„Ç∑„ÉñÂØæÂøúÔºà„É¢„Éê„Ç§„É´„Äú8KÔºâ
- Content Security Policy (CSP) „Å´„Çà„Çã„Çª„Ç≠„É•„É™„ÉÜ„Ç£Âº∑Âåñ

ÊäÄË°ìË¶Å‰ª∂:
- ÂØæÂøú„Éñ„É©„Ç¶„Ç∂: Chrome/Edge/Firefox/SafariÔºàÊúÄÊñ∞ÁâàÔºâ
- „Ç™„Éï„É©„Ç§„É≥Âãï‰ΩúÂØæÂøú
- Â§ñÈÉ®„É©„Ç§„Éñ„É©„É™‰∏ç‰ΩøÁî®ÔºàGoogle Fonts„ÇíÈô§„ÅèÔºâ

„Éê„Éº„Ç∏„Éß„É≥Â±•Ê≠¥:
- v1.8.0 (2025-01-08): Content Security Policy (CSP) ÂÆüË£Ö„Å´„Çà„Çã„Çª„Ç≠„É•„É™„ÉÜ„Ç£Âº∑Âåñ
  - XSSÊîªÊíÉÈò≤Âæ°„ÅÆ„Åü„ÇÅ„ÅÆCSP„É°„Çø„Çø„Ç∞ËøΩÂä†
  - CSPÈÅïÂèçÊ§úÁü•Ê©üËÉΩ„ÅÆÂÆüË£Ö
  - Âç∞Âà∑Ê©üËÉΩ„Å∏„ÅÆCSPÈÅ©Áî®
  - Â∞ÜÊù•ÁöÑ„Å™nonce-based CSP„Å∏„ÅÆÁßªË°åÊ∫ñÂÇô
- v1.7.0: Âç∞Âà∑Ê©üËÉΩÊîπËâØÁâàÔºàÂàùÊúü„É™„É™„Éº„ÇπÔºâ

Copyright (c) 2025 HarmoniaEpic
MIT License: https://opensource.org/licenses/MIT
-->
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Á∏¶Êõ∏„Åç„É°„É¢„Ç¢„Éó„É™ - ÊïôËÇ≤ÁèæÂ†¥Âêë„Åë„ÅÆÁ∏¶Êõ∏„Åç„ÉÜ„Ç≠„Çπ„Éà„Ç®„Éá„Ç£„Çø„ÄÇ„Éû„Éº„Ç´„ÉºÊ©üËÉΩ‰ªò„Åç„ÄÇ">
    <meta name="author" content="HarmoniaEpic">
    <meta name="license" content="MIT License">
    <link rel="icon" type="image/png" sizes="512x512" href="/tategaki-memo-pwa/icons/icon-512x512.png">
    <link rel="icon" type="image/png" sizes="384x384" href="/tategaki-memo-pwa/icons/icon-384x384.png">
    <link rel="icon" type="image/png" sizes="192x192" href="/tategaki-memo-pwa/icons/icon-192x192.png">
    <link rel="icon" type="image/png" sizes="152x152" href="/tategaki-memo-pwa/icons/icon-152x152.png">
    <link rel="icon" type="image/png" sizes="144x144" href="/tategaki-memo-pwa/icons/icon-144x144.png">
    <link rel="icon" type="image/png" sizes="128x128" href="/tategaki-memo-pwa/icons/icon-128x128.png">
    <link rel="icon" type="image/png" sizes="96x96" href="/tategaki-memo-pwa/icons/icon-96x96.png">
    <link rel="icon" type="image/png" sizes="72x72" href="/tategaki-memo-pwa/icons/icon-72x72.png">
    <link rel="icon" type="image/png" sizes="32x32" href="/tategaki-memo-pwa/icons/icon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/tategaki-memo-pwa/icons/icon-16x16.png">
  
    <!-- 
    === Content Security Policy (CSP) Ë®≠ÂÆö ===
    ÊïôËÇ≤ÁèæÂ†¥„Åß„ÅÆÂÆâÂÖ®„Å™Âà©Áî®„ÇíÁ¢∫‰øù„Åô„Çã„Åü„ÇÅ„ÅÆ„Çª„Ç≠„É•„É™„ÉÜ„Ç£„Éù„É™„Ç∑„Éº
    
    ÁèæÂú®„ÅÆË®≠ÂÆö:
    - default-src 'self': Âü∫Êú¨ÁöÑ„Å´Ëá™Â∑±„Éõ„Çπ„Éà„ÅÆ„É™„ÇΩ„Éº„Çπ„ÅÆ„ÅøË®±ÂèØ
    - script-src 'self' 'unsafe-inline': „Ç§„É≥„É©„Ç§„É≥„Çπ„ÇØ„É™„Éó„Éà„ÇíË®±ÂèØÔºàÁèæÂú®„ÅÆÂÆüË£Ö„Å´ÂøÖË¶ÅÔºâ
    - style-src: „Ç§„É≥„É©„Ç§„É≥„Çπ„Çø„Ç§„É´„Å®Google Fonts„ÇíË®±ÂèØ
    - font-src: Google Fonts„ÅÆ„Éï„Ç©„É≥„Éà„Éï„Ç°„Ç§„É´„ÇíË®±ÂèØ
    - img-src: CanvasÊìç‰Ωú„ÅÆ„Åü„ÇÅdata:„Å®blob:„ÇíË®±ÂèØ
    - frame-src 'self': Âç∞Âà∑Ê©üËÉΩ„ÅÆiframe„ÅÆ„ÅøË®±ÂèØ
    - „Åù„ÅÆ‰ªñ: ‰∏çË¶Å„Å™Ê©üËÉΩ„ÅØÊòéÁ§∫ÁöÑ„Å´ÁÑ°ÂäπÂåñ
    - CSP„Å´Service WorkerÁî®„ÅÆË®≠ÂÆö„ÇíËøΩÂä†

    Â∞ÜÊù•ÁöÑ„Å™ÊîπÂñÑ:
    - 'unsafe-inline'„Çínonce-based CSP„Å´ÁßªË°å
    - scriptË¶ÅÁ¥†„Å®styleË¶ÅÁ¥†„Å´nonceÂ±ûÊÄß„ÇíËøΩÂä†
    - „Çµ„Éº„Éê„Éº„Çµ„Ç§„Éâ„Åßnonce„ÇíÁîüÊàê„Åô„Çã‰ªïÁµÑ„Åø„ÅÆÂ∞éÂÖ•
    -->
    <meta http-equiv="Content-Security-Policy" content="
        default-src 'self';
        script-src 'self' 'unsafe-inline';
        style-src 'self' 'unsafe-inline' https://fonts.googleapis.com;
        font-src 'self' https://fonts.gstatic.com data:;
        img-src 'self' data: blob:;
        connect-src 'self';
        object-src 'none';
        media-src 'none';
        frame-src 'self';
        frame-ancestors 'none';
        base-uri 'self';
        form-action 'none';
        worker-src 'self';
        manifest-src 'self';
        upgrade-insecure-requests;
    ">

    <!-- CSPÈÅïÂèç„É¨„Éù„Éº„ÉàÁî®ÔºàÈñãÁô∫Áí∞Â¢ÉÁî®Ôºâ
    <meta http-equiv="Content-Security-Policy-Report-Only" content="
        default-src 'self'; 
        report-uri /csp-violation-report;
    ">
    -->
    
    <title>Á∏¶Êõ∏„Åç„É°„É¢ v1.8.0 - SVG‰øùÂ≠ò„ÉªË™≠Ëæº„Ç¢„Éó„É™Ôºà„Éû„Éº„Ç´„ÉºÊ©üËÉΩ‰ªò„ÅçÔºâ</title>

    <!-- PWAÈñ¢ÈÄ£„ÅÆ„É°„Çø„Çø„Ç∞ -->
    <link rel="manifest" href="/tategaki-memo-pwa/manifest.json">
    <meta name="theme-color" content="#4f46e5">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="Á∏¶Êõ∏„Åç„É°„É¢">
    <link rel="apple-touch-icon" href="/tategaki-memo-pwa/icons/icon-192x192.png">

    <style>
        /* === Google FontsË™≠„ÅøËæº„Åø === */
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;500;700&family=Noto+Serif+JP:wght@400;600&family=Klee+One:wght@400;600&display=swap');
        
        /* === ÂãïÁöÑ„Çπ„Ç±„Éº„É™„É≥„Ç∞Áî®CSSÂ§âÊï∞ === */
        :root {
            /* Âü∫Ê∫ñ„Çπ„Ç±„Éº„É´ÂÄ§ÔºàËß£ÂÉèÂ∫¶„Å´Âøú„Åò„Å¶JS„ÅßÊõ¥Êñ∞Ôºâ */
            --base-scale: 1;      /* ÂÖ®‰ΩìÁöÑ„Å™„Çπ„Ç±„Éº„É´ */
            --font-scale: 1;      /* „Éï„Ç©„É≥„ÉàÂ∞ÇÁî®„Çπ„Ç±„Éº„É´ */
            --ui-scale: 1;        /* UIË¶ÅÁ¥†Â∞ÇÁî®„Çπ„Ç±„Éº„É´ */
            --min-touch-target: 44px; /* WCAG AAÊ∫ñÊã†„ÅÆÊúÄÂ∞è„Çø„ÉÉ„ÉÅ„Çø„Éº„Ç≤„ÉÉ„Éà */
            
            /* „Ç´„É©„Éº„Éë„É¨„ÉÉ„Éà */
            --gray-50: #f9fafb;
            --gray-100: #f3f4f6;
            --gray-200: #e5e7eb;
            --gray-300: #d1d5db;
            --gray-400: #9ca3af;
            --gray-500: #6b7280;
            --gray-600: #4b5563;
            --gray-700: #374151;
            --gray-800: #1f2937;
            
            --indigo-400: #818cf8;
            --indigo-500: #6366f1;
            --indigo-600: #4f46e5;
            --indigo-700: #4338ca;
            
            --purple-500: #a855f7;
            --purple-600: #9333ea;
            --purple-700: #7c3aed;
            
            --green-300: #86efac;
            --green-700: #15803d;
            --green-800: #166534;
            
            --teal-500: #14b8a6;
            --teal-600: #0d9488;
            --teal-700: #0f766e;
            
            --red-500: #ef4444;
            --red-600: #dc2626;
            
            /* „Çπ„Éö„Éº„Ç∑„É≥„Ç∞ */
            --space-1: 0.25rem;
            --space-2: 0.5rem;
            --space-3: 0.75rem;
            --space-4: 1rem;
            --space-6: 1.5rem;
            --space-8: 2rem;
        }
        
        /* === „É™„Çª„ÉÉ„Éà„ÉªÂü∫Êú¨Ë®≠ÂÆö === */
        *, ::before, ::after {
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Noto Sans JP', sans-serif;
        }
        
        /* === „É¨„Ç§„Ç¢„Ç¶„Éà„É¶„Éº„ÉÜ„Ç£„É™„ÉÜ„Ç£ === */
        .flex { display: flex; }
        .inline-flex { display: inline-flex; }
        .grid { display: grid; }
        .hidden { display: none; }
        .block { display: block; }
        .relative { position: relative; }
        .absolute { position: absolute; }
        .overflow-hidden { overflow: hidden; }
        .overflow-auto { overflow: auto; }
        
        .top-2 { top: var(--space-2); }
        .left-2 { left: var(--space-2); }
        .right-0 { right: 0; }
        .z-50 { z-index: 50; }
        
        .w-full { width: 100%; }
        .h-full { height: 100%; }
        .h-screen { height: 100vh; }
        .min-h-0 { min-height: 0; }
        .flex-1 { flex: 1 1 0%; }
        .flex-shrink-0 { flex-shrink: 0; }
        
        .flex-col { flex-direction: column; }
        .flex-wrap { flex-wrap: wrap; }
        .justify-between { justify-content: space-between; }
        .items-center { align-items: center; }
        .text-center { text-align: center; }
        
        .grid-cols-1 { grid-template-columns: repeat(1, minmax(0, 1fr)); }
        
        /* === „Çπ„Éö„Éº„Ç∑„É≥„Ç∞ === */
        .p-2 { padding: var(--space-2); }
        .px-3 { padding-left: var(--space-3); padding-right: var(--space-3); }
        .px-4 { padding-left: var(--space-4); padding-right: var(--space-4); }
        .py-1 { padding-top: var(--space-1); padding-bottom: var(--space-1); }
        .py-2 { padding-top: var(--space-2); padding-bottom: var(--space-2); }
        .ml-3 { margin-left: var(--space-3); }
        .mr-4 { margin-right: var(--space-4); }
        .mt-1 { margin-top: var(--space-1); }
        
        /* === Ëâ≤ÂΩ© === */
        .bg-gray-50 { background-color: var(--gray-50); }
        .bg-gray-100 { background-color: var(--gray-100); }
        .bg-gray-200 { background-color: var(--gray-200); }
        .bg-gray-600 { background-color: var(--gray-600); }
        .bg-gray-700 { background-color: var(--gray-700); }
        .bg-gray-800 { background-color: var(--gray-800); }
        .bg-white { background-color: white; }
        .bg-indigo-600 { background-color: var(--indigo-600); }
        .bg-purple-600 { background-color: var(--purple-600); }
        .bg-teal-600 { background-color: var(--teal-600); }
        .bg-green-700 { background-color: var(--green-700); }
        .bg-red-500 { background-color: var(--red-500); }
        .bg-red-600 { background-color: var(--red-600); }
        
        .text-white { color: white; }
        .text-gray-400 { color: var(--gray-400); }
        .text-gray-500 { color: var(--gray-500); }
        .text-gray-600 { color: var(--gray-600); }
        .text-gray-700 { color: var(--gray-700); }
        .text-gray-800 { color: var(--gray-800); }
        .text-gray-900 { color: #111827; }
        .text-indigo-500 { color: var(--indigo-500); }
        
        /* === „Éú„Éº„ÉÄ„Éº === */
        .border { border-width: 1px; }
        .border-t { border-top-width: 1px; }
        .border-l { border-left-width: 1px; }
        .border-gray-200 { border-color: var(--gray-200); }
        .border-gray-300 { border-color: var(--gray-300); }
        .border-gray-400 { border-color: var(--gray-400); }
        .border-gray-600 { border-color: var(--gray-600); }
        .border-teal-500 { border-color: var(--teal-500); }
        
        /* === Ë£ÖÈ£æ === */
        .rounded { border-radius: 0.25rem; }
        .rounded-md { border-radius: 0.375rem; }
        .rounded-lg { border-radius: 0.5rem; }
        .rounded-l-lg { border-top-left-radius: 0.5rem; border-bottom-left-radius: 0.5rem; }
        .rounded-r-lg { border-top-right-radius: 0.5rem; border-bottom-right-radius: 0.5rem; }
        .rounded-full { border-radius: 9999px; }
        
        .shadow-sm { box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05); }
        .shadow-lg { box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05); }
        .shadow-xl { box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04); }
        
        /* === „Çø„Ç§„Éù„Ç∞„É©„Éï„Ç£ === */
        .font-bold { font-weight: 700; }
        .font-medium { font-weight: 500; }
        .font-semibold { font-weight: 600; }
        .underline { text-decoration: underline; }
        .whitespace-nowrap { white-space: nowrap; }
        
        /* === „Ç§„É≥„Çø„É©„ÇØ„Ç∑„Éß„É≥ === */
        .cursor-pointer { cursor: pointer; }
        .cursor-help { cursor: help; }
        .resize-none { resize: none; }
        
        /* === „Ç¢„ÇØ„Çª„Ç∑„Éì„É™„ÉÜ„Ç£ === */
        .sr-only {
            position: absolute;
            width: 1px;
            height: 1px;
            padding: 0;
            margin: -1px;
            overflow: hidden;
            clip: rect(0, 0, 0, 0);
            white-space: nowrap;
            border-width: 0;
        }
        
        /* === „Éï„Ç©„Éº„É†Ë¶ÅÁ¥† === */
        ::placeholder {
            color: var(--gray-400);
            opacity: 1;
        }
        
        /* === „Éà„É©„É≥„Ç∏„Ç∑„Éß„É≥ === */
        .transition { transition-property: all; transition-timing-function: cubic-bezier(0.4, 0, 0.2, 1); transition-duration: 150ms; }
        .transition-all { transition-property: all; transition-timing-function: cubic-bezier(0.4, 0, 0.2, 1); transition-duration: 150ms; }
        .transition-colors { transition-property: background-color, border-color, color, fill, stroke; transition-timing-function: cubic-bezier(0.4, 0, 0.2, 1); transition-duration: 150ms; }
        .transition-transform { transition-property: transform; transition-timing-function: cubic-bezier(0.4, 0, 0.2, 1); transition-duration: 150ms; }
        .duration-150 { transition-duration: 150ms; }
        
        /* === hoverÁä∂ÊÖã === */
        .hover\:bg-gray-100:hover { background-color: var(--gray-100); }
        .hover\:bg-gray-600:hover { background-color: var(--gray-600); }
        .hover\:bg-gray-700:hover { background-color: var(--gray-700); }
        .hover\:bg-indigo-700:hover { background-color: var(--indigo-700); }
        .hover\:bg-purple-700:hover { background-color: var(--purple-700); }
        .hover\:bg-teal-700:hover { background-color: var(--teal-700); }
        .hover\:bg-red-600:hover { background-color: var(--red-600); }
        .hover\:text-indigo-700:hover { color: var(--indigo-700); }
        .hover\:scale-105:hover { transform: scale(1.05); }
        
        /* === focusÁä∂ÊÖã === */
        .focus\:outline-none:focus { outline: 2px solid transparent; outline-offset: 2px; }
        .focus\:ring-2:focus { box-shadow: 0 0 0 0.125rem var(--indigo-400); }
        .focus\:ring-offset-2:focus { box-shadow: 0 0 0 0.125rem white, 0 0 0 0.25rem var(--indigo-500); }
        .focus\:ring-indigo-300:focus { box-shadow: 0 0 0 0.25rem rgba(165, 180, 252, 0.75); }
        .focus\:ring-indigo-400:focus { box-shadow: 0 0 0 0.125rem var(--indigo-400); }
        .focus\:ring-indigo-500:focus { box-shadow: 0 0 0 0.125rem white, 0 0 0 0.25rem var(--indigo-500); }
        .focus\:ring-purple-500:focus { box-shadow: 0 0 0 0.125rem white, 0 0 0 0.25rem var(--purple-500); }
        .focus\:ring-gray-500:focus { box-shadow: 0 0 0 0.125rem white, 0 0 0 0.25rem var(--gray-500); }
        .focus\:ring-teal-500:focus { box-shadow: 0 0 0 0.125rem white, 0 0 0 0.25rem var(--teal-500); }
        .focus\:border-indigo-400:focus { border-color: var(--indigo-400); }
        
        /* === „Éà„Ç∞„É´„Çπ„Ç§„ÉÉ„ÉÅ === */
        .peer:checked ~ .peer-checked\:after\:translate-x-full::after { transform: translateX(100%); }
        .peer:checked ~ .peer-checked\:after\:border-white::after { border-color: white; }
        .peer:checked ~ .peer-checked\:bg-indigo-600 { background-color: var(--indigo-600); }
        .peer:checked ~ .peer-checked\:bg-green-700 { background-color: var(--green-700); }
        .peer:focus ~ .peer-focus\:ring-4 { box-shadow: 0 0 0 0.25rem rgba(165, 180, 252, 0.75); }
        .peer:focus ~ .peer-focus\:ring-indigo-300 { box-shadow: 0 0 0 0.25rem rgba(165, 180, 252, 0.75); }
        .peer:focus ~ .peer-focus\:ring-green-300 { box-shadow: 0 0 0 0.25rem rgba(134, 239, 172, 0.75); }
        
        /* === Êì¨‰ººË¶ÅÁ¥† === */
        .after\:content-\[\'\'\]::after { content: ''; }
        .after\:absolute::after { position: absolute; }
        .after\:bg-white::after { background-color: white; }
        .after\:border-gray-300::after { border-color: var(--gray-300); }
        .after\:border::after { border-width: 1px; }
        .after\:rounded-full::after { border-radius: 9999px; }
        .after\:transition-all::after { transition-property: all; transition-timing-function: cubic-bezier(0.4, 0, 0.2, 1); transition-duration: 150ms; }
        
        /* === „É¨„Çπ„Éù„É≥„Ç∑„ÉñË®≠Ë®à === */
        /* „Çø„Éñ„É¨„ÉÉ„Éà‰ª•‰∏ä */
        @media (min-width: 768px) {
            .md\:grid-cols-1 { grid-template-columns: repeat(1, minmax(0, 1fr)); }
            .md\:grid-cols-2 { grid-template-columns: repeat(2, minmax(0, 1fr)); }
            .md\:col-span-2 { grid-column: span 2 / span 2; }
        }
        
        /* „Çπ„Éû„Éº„Éà„Éï„Ç©„É≥ÂØæÂøú */
        @media (max-width: 640px) {
            .flex-wrap { flex-wrap: wrap; }
            
            /* Â∞èÁîªÈù¢Áî®„ÅÆÂãïÁöÑ„ÉÜ„Ç≠„Çπ„Éà„Çµ„Ç§„Ç∫ */
            .dynamic-text-base {
                font-size: clamp(12px, calc(12px * var(--font-scale)), 60px);
            }
            
            .dynamic-button {
                padding: clamp(6px, calc(6px * var(--ui-scale)), 24px) clamp(12px, calc(12px * var(--ui-scale)), 48px);
                font-size: clamp(14px, calc(14px * var(--font-scale)), 56px);
            }
            
            .dynamic-gap-3 {
                gap: clamp(8px, calc(8px * var(--base-scale)), 32px);
            }
            
            #color-preview {
                font-size: clamp(16px, calc(16px * var(--font-scale)), 80px);
            }
        }
        
        /* 4KÂØæÂøú: ÂÆüÊ©ü„ÉÜ„Çπ„Éà„Å´Âü∫„Å•„ÅèÂÄ§ */
        @media (min-width: 3840px) {
            :root {
                --base-scale: 1.5;
                --font-scale: 2;
                --ui-scale: 1.5;
                --min-touch-target: 66px;
            }
        }

        /* 8KÂØæÂøú: Â∞ÜÊù•ÁöÑ„Å™Êã°Âºµ„ÇíËÄÉÊÖÆ */
        @media (min-width: 7680px) {
            :root {
                --base-scale: 2;
                --font-scale: 2.5;
                --ui-scale: 2;
                --min-touch-target: 88px;
            }
        }
        
        /* === Á∏¶Êõ∏„ÅçÂ∞ÇÁî®„Çπ„Çø„Ç§„É´ === */
        .vertical-text {
            writing-mode: vertical-rl;
            text-orientation: upright;
            white-space: pre;
            overflow: auto;
        }
        
        /* === „Ç´„Çπ„Çø„É†„Çπ„ÇØ„É≠„Éº„É´„Éê„Éº === */
        ::-webkit-scrollbar {
            width: calc(8px * var(--ui-scale));
            height: calc(8px * var(--ui-scale));
        }
        ::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 10px;
        }
        ::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 10px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #555;
        }

        /* === ÂãïÁöÑ„Çµ„Ç§„Ç∫Ë™øÊï¥„ÇØ„É©„Çπ === */
        .dynamic-text-base {
            font-size: clamp(14px, calc(14px * var(--font-scale)), 70px);
        }
        
        .dynamic-text-lg {
            font-size: clamp(18px, calc(18px * var(--font-scale)), 90px);
        }
        
        .dynamic-text-xl {
            font-size: clamp(20px, calc(20px * var(--font-scale)), 100px);
        }
        
        .dynamic-text-2xl {
            font-size: clamp(24px, calc(24px * var(--font-scale)), 90px);
        }
        
        .dynamic-p-2 {
            padding: clamp(8px, calc(8px * var(--base-scale)), 24px);
        }
        
        .dynamic-p-3 {
            padding: clamp(12px, calc(12px * var(--base-scale)), 32px);
        }
        
        .dynamic-p-4 {
            padding: clamp(16px, calc(16px * var(--base-scale)), 48px);
        }
        
        .dynamic-p-6 {
            padding: clamp(24px, calc(24px * var(--base-scale)), 64px);
        }
        
        .dynamic-px-4 {
            padding-left: clamp(16px, calc(16px * var(--base-scale)), 64px);
            padding-right: clamp(16px, calc(16px * var(--base-scale)), 64px);
        }
        
        .dynamic-py-0-5 {
            padding-top: clamp(2px, calc(2px * var(--base-scale)), 8px);
            padding-bottom: clamp(2px, calc(2px * var(--base-scale)), 8px);
        }
        
        .dynamic-py-1 {
            padding-top: clamp(4px, calc(4px * var(--base-scale)), 16px);
            padding-bottom: clamp(4px, calc(4px * var(--base-scale)), 16px);
        }
        
        .dynamic-py-2 {
            padding-top: clamp(8px, calc(8px * var(--base-scale)), 32px);
            padding-bottom: clamp(8px, calc(8px * var(--base-scale)), 32px);
        }
        
        .dynamic-gap-1 {
            gap: clamp(4px, calc(4px * var(--base-scale)), 16px);
        }
        
        .dynamic-gap-3 {
            gap: clamp(12px, calc(12px * var(--base-scale)), 48px);
        }
        
        .dynamic-gap-6 {
            gap: clamp(24px, calc(24px * var(--base-scale)), 96px);
        }
        
        /* === „Çø„ÉÉ„ÉÅÊìç‰ΩúÊúÄÈÅ©Âåñ === */
        .touch-target {
            min-height: min(var(--min-touch-target), 66px);  /* ÊúÄÂ§ß66px„Å´Âà∂Èôê */
            min-width: min(var(--min-touch-target), 66px);   /* ÊúÄÂ§ß66px„Å´Âà∂Èôê */
        }
        
        /* === „Éï„Ç©„Éº„É†Ë¶ÅÁ¥†„ÅÆÂãïÁöÑ„Çµ„Ç§„Ç∫ === */
        .dynamic-select {
            font-size: clamp(14px, calc(14px * var(--font-scale)), 56px);
            padding: clamp(4px, calc(4px * var(--ui-scale)), 16px) clamp(8px, calc(8px * var(--ui-scale)), 32px);
            min-height: var(--min-touch-target);
        }
        
        .dynamic-button {
            font-size: clamp(16px, calc(16px * var(--font-scale)), 64px);
            padding: clamp(8px, calc(8px * var(--ui-scale)), 32px) clamp(16px, calc(16px * var(--ui-scale)), 64px);
            min-height: var(--min-touch-target);
            border: none;
            outline: none;
        }
        
        /* === „Ç´„Çπ„Çø„É†„Ç¢„Ç¶„Éà„É©„Ç§„É≥ÂäπÊûú === */
        .outline-purple {
            box-shadow: 0 0 0 2px rgba(147, 51, 234, 0.3);
        }
        .outline-purple:hover {
            box-shadow: 0 0 0 3px rgba(147, 51, 234, 0.5), 0 0 15px rgba(147, 51, 234, 0.3);
        }
        
        .outline-indigo {
            box-shadow: 0 0 0 2px rgba(99, 102, 241, 0.3);
        }
        .outline-indigo:hover {
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.5), 0 0 15px rgba(99, 102, 241, 0.3);
        }
        
        .outline-gray {
            box-shadow: 0 0 0 2px rgba(107, 114, 128, 0.3);
        }
        .outline-gray:hover {
            box-shadow: 0 0 0 3px rgba(107, 114, 128, 0.5), 0 0 15px rgba(107, 114, 128, 0.3);
        }
        
        .outline-teal {
            box-shadow: 0 0 0 2px rgba(20, 184, 166, 0.3);
        }
        .outline-teal:hover {
            box-shadow: 0 0 0 3px rgba(20, 184, 166, 0.5), 0 0 15px rgba(20, 184, 166, 0.3);
        }
        
        /* === „Éà„Ç∞„É´„Çπ„Ç§„ÉÉ„ÉÅÂãïÁöÑ„Çµ„Ç§„Ç∫ === */
        .dynamic-toggle {
            position: relative;
            width: clamp(44px, calc(44px * var(--ui-scale)), 176px);
            height: clamp(24px, calc(24px * var(--ui-scale)), 96px);
        }
        
        .dynamic-toggle::after {
            content: '';
            position: absolute;
            width: clamp(20px, calc(20px * var(--ui-scale)), 80px);
            height: clamp(20px, calc(20px * var(--ui-scale)), 80px);
            top: clamp(2px, calc(2px * var(--ui-scale)), 8px);
            left: clamp(2px, calc(2px * var(--ui-scale)), 8px);
            background: white;
            border: 1px solid var(--gray-300);
            border-radius: 9999px;
            transition: all 0.15s;
        }
        
        input[type="checkbox"]:checked + .dynamic-toggle::after {
            transform: translateX(calc(clamp(20px, calc(20px * var(--ui-scale)), 80px)));
        }
        
        .dynamic-border {
            border-width: clamp(1px, calc(1px * var(--ui-scale)), 2px);
        }

        /* === „Éû„Éº„Ç´„ÉºÊ©üËÉΩÂ∞ÇÁî®„Çπ„Çø„Ç§„É´ === */
        #marker-menu {
            z-index: 50;
        }
        
        #marker-palette {
            min-width: clamp(60px, calc(60px * var(--ui-scale)), 240px);
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        
        .marker-color {
            display: block;
            width: 100%;
            padding: clamp(8px, calc(8px * var(--ui-scale)), 32px);
            font-size: clamp(20px, calc(20px * var(--font-scale)), 80px);
            text-align: center;
            background: white;
            border: none;
            transition: all 0.2s;
            cursor: pointer;
        }
        
        .marker-color:hover {
            background-color: #f3f4f6;
            transform: scale(1.1);
        }
        
        .marker-color.active {
            background-color: #e5e7eb;
            box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.1);
        }
        
        #marker-eraser {
            display: block;
            width: 100%;
            padding: clamp(8px, calc(8px * var(--ui-scale)), 32px);
            font-size: clamp(20px, calc(20px * var(--font-scale)), 80px);
            text-align: center;
            background: white;
            border: none;
            border-top: 1px solid #e5e7eb;
            transition: all 0.2s;
            cursor: pointer;
        }
        
        #marker-eraser:hover {
            background-color: #f3f4f6;
            transform: scale(1.1);
        }
        
        #marker-eraser.active {
            background-color: #fee2e2;
            box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.1);
        }
        
        #marker-clear {
            display: block;
            width: 100%;
            padding: clamp(8px, calc(8px * var(--ui-scale)), 32px);
            font-size: clamp(14px, calc(14px * var(--font-scale)), 56px);
            text-align: center;
            background: var(--red-500);
            color: white;
            border: none;
            border-radius: 0 0 0.375rem 0.375rem;
            transition: all 0.2s;
            cursor: pointer;
        }
        
        #marker-clear:hover {
            background-color: var(--red-600);
        }
        
        /* „Éû„Éº„Ç´„ÉºËâ≤ÂÆöÁæ©ÔºàRGBAÂÄ§„ÅßÈÄèÈÅéÂ∫¶„ÇíË®≠ÂÆöÔºâ */
        .marker-yellow { background-color: rgba(255, 255, 0, 0.4); }
        .marker-red    { background-color: rgba(255, 107, 107, 0.4); }
        .marker-blue   { background-color: rgba(77, 171, 247, 0.4); }
        .marker-green  { background-color: rgba(81, 207, 102, 0.4); }
        .marker-purple { background-color: rgba(204, 93, 232, 0.4); }
        
        /* „Éû„Éº„Ç´„Éº„É¢„Éº„ÉâÊôÇ„ÅÆ„Ç´„Éº„ÇΩ„É´Â§âÊõ¥ */
        .marker-mode {
            cursor: text !important;
        }
        
        /* ÈÅ∏ÊäûÊôÇ„ÅÆ„Éè„Ç§„É©„Ç§„ÉàËâ≤ */
        ::selection {
            background-color: rgba(99, 102, 241, 0.3);
        }
        
        .vertical-text::selection {
            background-color: rgba(99, 102, 241, 0.3);
        }
        
        /* === „ÉÑ„Éº„É´„ÉÅ„ÉÉ„Éó === */
        .tooltip {
            position: relative;
            display: inline-block;
        }
        
        .tooltip-text {
            visibility: hidden;
            width: clamp(250px, calc(250px * var(--ui-scale)), 500px);
            background-color: #333;
            color: #fff;
            text-align: left;
            border-radius: 6px;
            padding: clamp(8px, calc(8px * var(--ui-scale)), 16px) clamp(12px, calc(12px * var(--ui-scale)), 24px);
            position: absolute;
            z-index: 50;
            bottom: 125%;
            left: 50%;
            margin-left: clamp(-125px, calc(-125px * var(--ui-scale)), -250px);
            opacity: 0;
            transition: opacity 0.3s;
            font-size: clamp(12px, calc(12px * var(--font-scale)), 36px);
            line-height: 1.5;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        
        .tooltip-text::after {
            content: "";
            position: absolute;
            top: 100%;
            left: 50%;
            margin-left: -5px;
            border-width: 5px;
            border-style: solid;
            border-color: #333 transparent transparent transparent;
        }
        
        .tooltip:hover .tooltip-text {
            visibility: visible;
            opacity: 1;
        }
        
        /* === ÊñáÂ≠óËâ≤„Çª„É¨„ÇØ„Çø === */
        #text-color-selector {
            appearance: none;
            -webkit-appearance: none;
            -moz-appearance: none;
        }
        
        #text-color-selector option {
            font-family: 'Noto Sans JP', sans-serif;
            padding: 2px 5px;
            color: white;
            background-color: var(--gray-700);
        }
        
        #color-preview {
            display: inline-block;
            line-height: 1;
            filter: drop-shadow(0 0 1px rgba(0, 0, 0, 0.3));
        }
        
        /* ÁôΩ/ÈªÑËâ≤„ÅÆË¶ñË™çÊÄßÂêë‰∏ä */
        .color-preview-bordered {
            filter: drop-shadow(0 0 2px rgba(0, 0, 0, 0.5));
        }
        
        .preview-gray-bg {
            background-color: #e5e7eb !important;
        }
        
        .text-shadow-for-white {
            text-shadow: 0 0 3px rgba(0, 0, 0, 0.3);
        }
        
        /* ÈÄèÈÅéPNGÊé®Â•®„ÅÆÊÉÖÂ†±„Ç¢„Ç§„Ç≥„É≥ */
        .transparent-png-info {
            display: inline-block;
            margin-left: 8px;
            font-size: 0.9em;
            color: white;
            cursor: help;
            font-weight: bold;
        }
        
        /* === ÈªíÊùø„É¢„Éº„Éâ === */
        body.blackboard-mode {
            background-color: #1B4332;
        }
        
        body.blackboard-mode .bg-gray-100 {
            background-color: #1B4332;
        }
        
        body.blackboard-mode .bg-white {
            background-color: #0F4C3A;
        }
        
        body.blackboard-mode .text-gray-800 {
            color: #F0F0F0;
        }
        
        body.blackboard-mode .text-gray-900 {
            color: #F0F0F0;
        }
        
        body.blackboard-mode .text-gray-700 {
            color: #E0E0E0;
        }
        
        body.blackboard-mode .text-gray-600 {
            color: #D0D0D0;
        }
        
        body.blackboard-mode .text-gray-500 {
            color: #C0C0C0;
        }
        
        body.blackboard-mode .border-gray-300 {
            border-color: #2D6A4F;
        }
        
        body.blackboard-mode .border-gray-200 {
            border-color: #2D6A4F;
        }
        
        body.blackboard-mode .bg-gray-50 {
            background-color: #1B4332;
            border: 2px solid #2D6A4F;
        }
        
        body.blackboard-mode .vertical-text {
            color: #FFFFFF;
            text-shadow: 1px 1px 3px rgba(255, 255, 255, 0.5), 0 0 8px rgba(255, 255, 255, 0.2);
        }
        
        body.blackboard-mode textarea {
            background-color: #1B4332;
            color: #FFFFFF;
            text-shadow: 1px 1px 3px rgba(255, 255, 255, 0.5), 0 0 8px rgba(255, 255, 255, 0.2);
        }
        
        body.blackboard-mode textarea::placeholder {
            color: #A0C4B0;
            opacity: 0.7;
        }
        
        body.blackboard-mode .shadow-xl {
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.3), 0 10px 10px -5px rgba(0, 0, 0, 0.2);
        }
        
        body.blackboard-mode footer {
            background-color: #0F4C3A;
            border-top: 1px solid #2D6A4F;
        }
        
        body.blackboard-mode .bg-gray-800 {
            background-color: #081C15;
        }
        
        body.blackboard-mode .bg-gray-50.border-t {
            background-color: #0F4C3A;
            border-top-color: #2D6A4F;
        }
        
        body.blackboard-mode .preview-gray-bg {
            background-color: #2D6A4F !important;
        }
        
        body.blackboard-mode ::-webkit-scrollbar-track {
            background: #2D6A4F;
        }
        
        body.blackboard-mode ::-webkit-scrollbar-thumb {
            background: #52B788;
        }
        
        body.blackboard-mode ::-webkit-scrollbar-thumb:hover {
            background: #74C69D;
        }
        
        body.blackboard-mode .outline-purple,
        body.blackboard-mode .outline-indigo,
        body.blackboard-mode .outline-gray,
        body.blackboard-mode .outline-teal {
            box-shadow: 0 0 0 2px rgba(255, 255, 255, 0.2);
        }
        
        body.blackboard-mode .outline-purple:hover,
        body.blackboard-mode .outline-indigo:hover,
        body.blackboard-mode .outline-gray:hover,
        body.blackboard-mode .outline-teal:hover {
            box-shadow: 0 0 0 3px rgba(255, 255, 255, 0.3), 0 0 15px rgba(255, 255, 255, 0.2);
        }
        
        body.blackboard-mode ::selection {
            background-color: rgba(134, 239, 172, 0.4);
        }
        
        body.blackboard-mode .vertical-text::selection {
            background-color: rgba(134, 239, 172, 0.4);
        }
        
        body.blackboard-mode #png-menu,
        body.blackboard-mode #marker-palette {
            background-color: #1B4332;
            border-color: #2D6A4F;
        }

        body.blackboard-mode #png-menu button {
            color: #1B4332;
            background-color: #ffffff;
        }

        body.blackboard-mode #png-menu button:hover {
            color: #ffffff;
            background-color: #2D6A4F;
        }

        body.blackboard-mode .marker-color {
            background-color: #1B4332;
            border-color: #2D6A4F;
        }

        body.blackboard-mode .marker-color:hover {
            background-color: #2D6A4F;
        }
        
        body.blackboard-mode .marker-color.active {
            background-color: #40916C;
        }
        
        /* ÈªíÊùø„É¢„Éº„Éâ„ÅÆ„ÉÅ„Éß„Éº„ÇØÈ¢®„Éû„Éº„Ç´„Éº */
        body.blackboard-mode .marker-yellow { 
            background-color: rgba(255, 255, 150, 0.6);
            mix-blend-mode: screen;
        }
        body.blackboard-mode .marker-red { 
            background-color: rgba(255, 150, 150, 0.6);
            mix-blend-mode: screen;
        }
        body.blackboard-mode .marker-blue { 
            background-color: rgba(150, 200, 255, 0.6);
            mix-blend-mode: screen;
        }
        body.blackboard-mode .marker-green { 
            background-color: rgba(150, 255, 150, 0.6);
            mix-blend-mode: screen;
        }
        body.blackboard-mode .marker-purple { 
            background-color: rgba(220, 150, 255, 0.6);
            mix-blend-mode: screen;
        }
        
        body.blackboard-mode #esc-key-hint button {
            background-color: #1B4332;
            border-color: #52B788;
            color: #B7E4C7;
        }
        
        body.blackboard-mode #marker-mode-toggle-button[style*="background-color: rgb(209, 213, 219)"] {
            background-color: #52B788 !important;
            color: #081C15 !important;
            border-color: #74C69D !important;
        }
        
        body.blackboard-mode label span.text-gray-900 {
            color: #D0F0DE;
        }
        
        body.blackboard-mode .dynamic-toggle.bg-gray-200 {
            background-color: #2D6A4F;
        }
        
        body.blackboard-mode #marker-clear {
            background-color: #D62828;
            color: white;
        }
        
        body.blackboard-mode #marker-clear:hover {
            background-color: #F94144;
        }
        
        body.blackboard-mode .tooltip-text {
            background-color: #081C15;
            border: 1px solid #2D6A4F;
        }
        
        body.blackboard-mode .tooltip-text::after {
            border-color: #081C15 transparent transparent transparent;
        }
        
        /* === PNG„Ç®„ÇØ„Çπ„Éù„Éº„Éà„Éú„Çø„É≥ === */
        #export-png-button {
            border-radius: 0.5rem 0 0 0.5rem;
            margin-right: 1px;
        }
        
        #png-menu-toggle {
            border-radius: 0 0.5rem 0.5rem 0;
            min-width: auto;
            padding-left: 0.75rem;
            padding-right: 0.75rem;
            margin-left: -1px;
            box-shadow: inset 1px 0 0 rgba(255, 255, 255, 0.2), 0 0 0 2px rgba(20, 184, 166, 0.3);
        }
        
        #png-menu-toggle:hover {
            box-shadow: inset 1px 0 0 rgba(255, 255, 255, 0.2), 0 0 0 3px rgba(20, 184, 166, 0.5), 0 0 15px rgba(20, 184, 166, 0.3);
        }
        
        #png-menu {
            margin-top: 0.25rem;
            border: 1px solid var(--gray-200);
            box-shadow: 0 -4px 6px rgba(0, 0, 0, 0.1), 0 -2px 4px rgba(0, 0, 0, 0.06);
        }
        
        /* === ÂÖ®ÁîªÈù¢„Éú„Çø„É≥ === */
        #fullscreen-toggle {
            padding: clamp(8px, calc(8px * var(--ui-scale)), 32px) clamp(12px, calc(12px * var(--ui-scale)), 48px);
            min-width: var(--min-touch-target);
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        #fullscreen-icon {
            display: block;
        }
        
        body.blackboard-mode #fullscreen-toggle {
            background-color: #2D6A4F;
        }
        
        body.blackboard-mode #fullscreen-toggle:hover {
            background-color: #40916C;
        }
        
        body.fullscreen-active {
            background: var(--gray-100);
        }
        
        body.fullscreen-active.blackboard-mode {
            background: #1B4332;
        }
        
        body.fullscreen-active .dynamic-p-6 {
            padding: clamp(12px, calc(12px * var(--base-scale)), 48px);
        }
        
        #fullscreen-icon line,
        #fullscreen-icon polyline {
            stroke-width: 2;
            vector-effect: non-scaling-stroke;
        }
        
        body.blackboard-mode .blackboard-mode-bg {
            background-color: #2D6A4F;
        }
        
        body.blackboard-mode .blackboard-mode-bg:hover {
            background-color: #40916C;
        }
        
        body.blackboard-mode #fullscreen-toggle.outline-gray {
            box-shadow: 0 0 0 2px rgba(255, 255, 255, 0.2);
        }
        
        body.blackboard-mode #fullscreen-toggle.outline-gray:hover {
            box-shadow: 0 0 0 3px rgba(255, 255, 255, 0.3), 0 0 15px rgba(255, 255, 255, 0.2);
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800 h-screen flex flex-col overflow-hidden">

    <div class="flex-1 w-full bg-white shadow-xl flex flex-col overflow-hidden">
        <header class="bg-gray-800 text-white dynamic-p-2 flex justify-between items-center flex-wrap flex-shrink-0">
            <h1 class="dynamic-text-2xl font-bold mr-4">Á∏¶Êõ∏„Åç„É°„É¢</h1>
            <div class="flex items-center flex-wrap dynamic-gap-3">
                <!-- ÊñáÂ≠óÊèÉ„Åà„Çª„É¨„ÇØ„Çø -->
                <div>
                    <label for="alignment-selector" class="sr-only">ÊñáÂ≠óÊèÉ„Åà</label>
                    <select id="alignment-selector" class="dynamic-select bg-gray-700 text-white border border-gray-600 rounded-md focus:ring-2 focus:ring-indigo-400 focus:outline-none touch-target">
                        <option value="left">‰∏äÊèÉ„Åà</option>
                        <option value="center">‰∏≠Â§ÆÊèÉ„Åà</option>
                        <option value="right">‰∏ãÊèÉ„Åà</option>
                    </select>
                </div>
                <!-- „Éï„Ç©„É≥„Éà„Çª„É¨„ÇØ„Çø -->
                <div>
                    <label for="font-selector" class="sr-only">„Éï„Ç©„É≥„Éà„ÇíÈÅ∏Êäû</label>
                    <select id="font-selector" class="dynamic-select bg-gray-700 text-white border border-gray-600 rounded-md focus:ring-2 focus:ring-indigo-400 focus:outline-none touch-target">
                        <option value="'Noto Serif JP', 'Yu Mincho', 'Hiragino Mincho ProN', 'MS PMincho', serif" selected>ÊòéÊúù‰Ωì</option>
                        <option value="'Noto Sans JP', 'Yu Gothic', 'Hiragino Kaku Gothic ProN', 'MS PGothic', sans-serif">„Ç¥„Ç∑„ÉÉ„ÇØ‰Ωì</option>
                        <option value="'MS Gothic', 'Osaka-Mono', 'Consolas', monospace">Á≠âÂπÖ„Éï„Ç©„É≥„Éà</option>
                        <option value="system-ui, -apple-system, 'Yu Gothic UI', 'Meiryo', sans-serif">„Ç∑„Çπ„ÉÜ„É†„Éï„Ç©„É≥„Éà</option>
                        <option value="'Klee One', 'UD„Éá„Ç∏„Çø„É´ÊïôÁßëÊõ∏‰Ωì NK', 'UD „Éá„Ç∏„Çø„É´ ÊïôÁßëÊõ∏‰Ωì NK', 'UD„Éá„Ç∏„Çø„É´ÊïôÁßëÊõ∏‰Ωì NK-R', 'UD „Éá„Ç∏„Çø„É´ ÊïôÁßëÊõ∏‰Ωì NK-R', 'YuKyokasho', 'Yu Kyokasho', 'Hannotate SC', cursive, serif">ÊâãÊõ∏„ÅçÈ¢®</option>
                    </select>
                </div>
                <!-- „Éï„Ç©„É≥„Éà„Çµ„Ç§„Ç∫„Çª„É¨„ÇØ„Çø -->
                <div>
                    <label for="font-size-selector" class="sr-only">„Éï„Ç©„É≥„Éà„Çµ„Ç§„Ç∫</label>
                    <select id="font-size-selector" class="dynamic-select bg-gray-700 text-white border border-gray-600 rounded-md focus:ring-2 focus:ring-indigo-400 focus:outline-none touch-target">
                        <option value="16">16px</option>
                        <option value="20">20px</option>
                        <option value="24" selected>24px</option>
                        <option value="28">28px</option>
                        <option value="32">32px</option>
                        <option value="40">40px</option>
                        <option value="48">48px</option>
                        <option value="56">56px</option>
                        <option value="72">72px</option>
                        <option value="96">96px</option>
                        <option value="120">120px</option>
                        <option value="144">144px</option>
                        <option value="168">168px</option>
                        <option value="200">200px</option>
                    </select>
                </div>
                <!-- ÊñáÂ≠óËâ≤„Çª„É¨„ÇØ„Çø -->
                <div class="inline-flex items-center dynamic-gap-1">
                    <label for="text-color-selector" class="sr-only">ÊñáÂ≠óËâ≤„ÇíÈÅ∏Êäû</label>
                    <span id="color-preview" class="dynamic-text-xl" style="color: #000000;">‚ñ†</span>
                    <select id="text-color-selector" class="dynamic-select bg-gray-700 text-white border border-gray-600 rounded-md focus:ring-2 focus:ring-indigo-400 focus:outline-none touch-target">
                        <option value="#FFFFFF" data-color-name="ÁôΩ">ÁôΩ</option>
                        <option value="#808080" data-color-name="ÁÅ∞Ëâ≤">ÁÅ∞Ëâ≤</option>
                        <option value="#000000" data-color-name="Èªí" selected>Èªí</option>
                        <option value="#808000" data-color-name="„Ç™„É™„Éº„Éñ">„Ç™„É™„Éº„Éñ</option>
                        <option value="#A52A2A" data-color-name="Ëå∂Ëâ≤">Ëå∂Ëâ≤</option>
                        <option value="#FF0000" data-color-name="Ëµ§">Ëµ§</option>
                        <option value="#FFC0CB" data-color-name="„Éî„É≥„ÇØ">„Éî„É≥„ÇØ</option>
                        <option value="#FFA500" data-color-name="„Ç™„É¨„É≥„Ç∏">„Ç™„É¨„É≥„Ç∏</option>
                        <option value="#FFFF00" data-color-name="ÈªÑËâ≤">ÈªÑËâ≤</option>
                        <option value="#9ACD32" data-color-name="ÈªÑÁ∑ë">ÈªÑÁ∑ë</option>
                        <option value="#008000" data-color-name="Á∑ë">Á∑ë</option>
                        <option value="#20B2AA" data-color-name="ÈùíÁ∑ë">ÈùíÁ∑ë</option>
                        <option value="#0000FF" data-color-name="Èùí">Èùí</option>
                        <option value="#800080" data-color-name="Á¥´">Á¥´</option>
                        <option value="#C71585" data-color-name="Ëµ§Á¥´">Ëµ§Á¥´</option>
                        <option value="#EE82EE" data-color-name="„Åô„Åø„ÇåËâ≤">„Åô„Åø„ÇåËâ≤</option>
                    </select>
                    <span id="transparent-png-info" class="transparent-png-info hidden" title="ÁôΩ/ÈªÑËâ≤„ÅÆÊñáÂ≠ó„ÅØÈÄèÈÅéPNG„Åß„ÅÆ‰øùÂ≠ò„ÇíÊé®Â•®„Åó„Åæ„Åô">‚ìò</span>
                </div>
                <!-- Êäò„ÇäËøî„Åó„Éú„Çø„É≥ -->
                <div>
                     <label for="wrap-toggle" class="relative inline-flex items-center cursor-pointer">
                        <input type="checkbox" id="wrap-toggle" class="sr-only peer">
                        <div class="dynamic-toggle bg-gray-600 rounded-full peer peer-focus:ring-4 peer-focus:ring-indigo-300 peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:bg-white after:border-gray-300 after:border after:rounded-full after:transition-all peer-checked:bg-indigo-600"></div>
                        <span class="ml-3 dynamic-text-base font-medium text-white">Êäò„ÇäËøî„ÅóË°®Á§∫</span>
                    </label>
                </div>
                <!-- ÈªíÊùø„É¢„Éº„Éâ„Éú„Çø„É≥ -->
                <div>
                     <label for="blackboard-toggle" class="relative inline-flex items-center cursor-pointer">
                        <input type="checkbox" id="blackboard-toggle" class="sr-only peer">
                        <div class="dynamic-toggle bg-gray-600 rounded-full peer peer-focus:ring-4 peer-focus:ring-green-300 peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:bg-white after:border-gray-300 after:border after:rounded-full after:transition-all peer-checked:bg-green-700"></div>
                        <span class="ml-3 dynamic-text-base font-medium text-white">ÈªíÊùø„É¢„Éº„Éâ</span>
                    </label>
                </div>
                <!-- ÂÖ®ÁîªÈù¢„Éú„Çø„É≥ -->
                <div>
                    <button id="fullscreen-toggle" class="dynamic-button bg-gray-700 text-white rounded-lg hover:bg-gray-600 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-gray-500 transition-transform transform hover:scale-105 touch-target outline-gray" title="ÂÖ®ÁîªÈù¢Ë°®Á§∫">
                        <svg id="fullscreen-icon" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="width: clamp(20px, calc(20px * var(--ui-scale)), 80px); height: clamp(20px, calc(20px * var(--ui-scale)), 80px);">
                            <g id="expand-icon">
                                <polyline points="15 3 21 3 21 9"></polyline>
                                <polyline points="9 21 3 21 3 15"></polyline>
                                <line x1="21" y1="3" x2="14" y2="10"></line>
                                <line x1="3" y1="21" x2="10" y2="14"></line>
                            </g>
                            <g id="shrink-icon" style="display: none;">
                                <polyline points="4 14 10 14 10 20"></polyline>
                                <polyline points="20 10 14 10 14 4"></polyline>
                                <line x1="14" y1="10" x2="21" y2="3"></line>
                                <line x1="3" y1="21" x2="10" y2="14"></line>
                            </g>
                        </svg>
                    </button>
                </div>
            </div>
        </header>

        <main id="main-content" class="grid md:grid-cols-1 dynamic-gap-6 dynamic-p-6 flex-1 overflow-auto">
            <!-- „Éó„É¨„Éì„É•„Éº„Ç®„É™„Ç¢ („Éá„Éï„Ç©„É´„Éà„ÅßÈùûË°®Á§∫) -->
            <div id="preview-container" class="flex flex-col hidden h-full overflow-hidden">
                <div class="relative h-full overflow-hidden">
                    <!-- „Éû„Éº„Ç´„Éº„É°„Éã„É•„Éº -->
                    <div id="marker-menu" class="absolute top-2 left-2 z-50">
                        <button id="marker-toggle" class="p-2 bg-gray-700 text-white rounded hover:bg-gray-600 transition-colors touch-target blackboard-mode-bg">
                            ‚ò∞
                        </button>
                        <div id="marker-palette" class="hidden mt-1 bg-white shadow-lg rounded overflow-hidden">
                            <button class="marker-color" data-color="#FFFF00" title="ÈªÑËâ≤">üü°</button>
                            <button class="marker-color" data-color="#FF6B6B" title="Ëµ§Ëâ≤">üî¥</button>
                            <button class="marker-color" data-color="#4DABF7" title="ÈùíËâ≤">üîµ</button>
                            <button class="marker-color" data-color="#51CF66" title="Á∑ëËâ≤">üü¢</button>
                            <button class="marker-color" data-color="#CC5DE8" title="Á¥´Ëâ≤">üü£</button>
                            <button class="marker-color" data-color="transparent" title="Ê∂à„Åó„Ç¥„É†">üßΩ</button>
                            <button id="marker-clear">‚úï „ÇØ„É™„Ç¢</button>
                        </div>
                    </div>
                    <div id="preview-area" class="w-full h-full dynamic-p-4 border dynamic-border border-gray-300 rounded-md bg-gray-50 vertical-text overflow-auto">
                    </div>
                </div>
            </div>

            <!-- ÂÖ•Âäõ„Ç®„É™„Ç¢ -->
            <div id="input-container" class="flex flex-col md:col-span-2 h-full">
                <textarea id="text-input" class="w-full flex-1 min-h-0 dynamic-p-4 border dynamic-border border-gray-300 rounded-md focus:ring-2 focus:ring-indigo-400 focus:border-indigo-400 transition duration-150 resize-none vertical-text" placeholder="„Åì„Åì„Å´„ÉÜ„Ç≠„Çπ„Éà„Çí
ÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ

ÊîπË°å„Åô„Çã„Å®„ÄÅ
SVG„Åß„ÅØ
Êñ∞„Åó„ÅÑÂàó„Å´„Å™„Çä„Åæ„Åô„ÄÇ"></textarea>
                <input type="file" id="svg-load-input" class="hidden" accept="image/svg+xml">
            </div>
        </main>

        <!-- Êìç‰Ωú„Éê„Éº -->
        <div class="bg-gray-50 dynamic-p-2 border-t dynamic-border border-gray-200 flex justify-between items-center dynamic-gap-3 flex-shrink-0 flex-wrap">
            <div class="flex items-center dynamic-gap-3 flex-wrap flex-1">
                <!-- Âç∞Âà∑„Éú„Çø„É≥ -->
                <button id="print-button" class="dynamic-button bg-purple-600 text-white font-bold rounded-lg hover:bg-purple-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-purple-500 transition-transform transform hover:scale-105 touch-target outline-purple">
                    Âç∞Âà∑
                </button>
                
                <!-- „Éó„É¨„Éì„É•„Éº„Éà„Ç∞„É´ -->
                <label for="toggle-preview" class="relative inline-flex items-center cursor-pointer">
                    <input type="checkbox" id="toggle-preview" class="sr-only peer">
                    <div class="dynamic-toggle bg-gray-200 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:bg-white after:border-gray-300 after:border after:rounded-full after:transition-all peer-checked:bg-indigo-600"></div>
                    <span class="ml-3 dynamic-text-base text-gray-900 font-medium">„Éó„É¨„Éì„É•„Éº</span>
                </label>
                
                <!-- „Çπ„ÇØ„É≠„Éº„É´ÂêåÊúü„Éà„Ç∞„É´ -->
                <div id="scroll-sync-toggle-container" class="hidden">
                     <label for="scroll-sync-toggle" class="relative inline-flex items-center cursor-pointer">
                        <input type="checkbox" id="scroll-sync-toggle" class="sr-only peer" checked>
                        <div class="dynamic-toggle bg-gray-200 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:bg-white after:border-gray-300 after:border after:rounded-full after:transition-all peer-checked:bg-indigo-600"></div>
                        <span class="ml-3 dynamic-text-base font-medium text-gray-900">„Çπ„ÇØ„É≠„Éº„É´ÂêåÊúü</span>
                    </label>
                </div>
                
                <!-- „Éû„Éº„Ç´„Éº‰øùÂ≠ò„Éà„Ç∞„É´ -->
                <div id="save-markers-toggle-container" class="hidden">
                     <label for="save-markers-toggle" class="relative inline-flex items-center cursor-pointer">
                        <input type="checkbox" id="save-markers-toggle" class="sr-only peer" checked>
                        <div class="dynamic-toggle bg-gray-200 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:bg-white after:border-gray-300 after:border after:rounded-full after:transition-all peer-checked:bg-indigo-600"></div>
                        <span class="ml-3 dynamic-text-base font-medium text-gray-900">„Éû„Éº„Ç´„Éº„ÇíSVG„Å´‰øùÂ≠ò</span>
                    </label>
                </div>
                
                <!-- ESC„Ç≠„ÉºË™¨Êòé -->
                <div id="esc-key-hint" class="hidden">
                    <div class="tooltip">
                        <button id="marker-mode-toggle-button" class="dynamic-text-base text-gray-600 border border-gray-400 rounded px-4 py-2 shadow-sm inline-block transition-all duration-300 cursor-pointer hover:scale-105 focus:outline-none focus:ring-2 focus:ring-indigo-400" style="text-shadow: 1px 1px 2px rgba(0,0,0,0.1);">ESCÔºè„Çø„ÉÉ„ÉóÔºö„Éû„Éº„Ç´„Éº„É¢„Éº„ÉâÂàáÊõø</button>
                        <div class="tooltip-text">
                            „Éû„Éº„Ç´„Éº„É¢„Éº„Éâ„ÇíËß£Èô§„Åô„Çã„Å®ÈÄöÂ∏∏„ÅÆ„ÉÜ„Ç≠„Çπ„ÉàÈÅ∏Êäû„Åå„Åß„Åç„Åæ„Åô
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Êìç‰Ωú„Éú„Çø„É≥Áæ§ -->
            <div class="flex items-center dynamic-gap-3 flex-wrap">
                <button id="load-button" class="dynamic-button bg-gray-600 text-white font-bold rounded-lg hover:bg-gray-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-gray-500 transition-transform transform hover:scale-105 touch-target outline-gray">
                    SVG„ÇíË™≠„ÅøËæº„ÇÄ
                </button>
                <button id="save-button" class="dynamic-button bg-indigo-600 text-white font-bold rounded-lg hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 transition-transform transform hover:scale-105 touch-target outline-indigo">
                    SVG„Åß‰øùÂ≠ò
                </button>
                <!-- PNG„Ç®„ÇØ„Çπ„Éù„Éº„Éà„Éú„Çø„É≥Áæ§ -->
                <div class="relative inline-flex">
                    <button id="export-png-button" class="dynamic-button bg-teal-600 text-white font-bold hover:bg-teal-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-teal-500 transition-transform transform hover:scale-105 touch-target outline-teal">
                        PNG„Å´„Ç®„ÇØ„Çπ„Éù„Éº„Éà
                    </button>
                    <button id="png-menu-toggle" class="dynamic-button bg-teal-600 text-white font-bold hover:bg-teal-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-teal-500 transition-transform transform hover:scale-105 touch-target">
                        ‚ñ≥
                    </button>
                    <div id="png-menu" class="absolute right-0 hidden bg-white rounded-md shadow-lg z-50" style="bottom: 100%; margin-bottom: 0.25rem; min-width: 200px;">
                        <button id="export-transparent-png-button" class="block w-full text-left px-4 py-2 text-gray-700 hover:bg-gray-100 rounded-md dynamic-text-base whitespace-nowrap">
                            ÈÄèÈÅéPNG„Å´„Ç®„ÇØ„Çπ„Éù„Éº„Éà
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <footer class="text-center text-gray-500 dynamic-py-0-5 flex-shrink-0">
        <p class="dynamic-text-base">
            &copy; 2025 HarmoniaEpic | 
            <span class="text-gray-600">MIT License</span> | 
            <a href="https://opensource.org/licenses/MIT" class="text-indigo-500 hover:text-indigo-700 underline" target="_blank" rel="noopener noreferrer">„É©„Ç§„Çª„É≥„ÇπË©≥Á¥∞</a> | 
            <span class="text-gray-500" style="font-size: 0.875em;">CSS„É¶„Éº„ÉÜ„Ç£„É™„ÉÜ„Ç£„ÇØ„É©„Çπ„ÅÆ‰∏ÄÈÉ®„ÅØ <a href="https://tailwindcss.com" class="text-indigo-500 hover:text-indigo-700 underline" target="_blank" rel="noopener noreferrer">Tailwind CSS</a> „ÇíÂèÇËÄÉ„Å´„Åó„Å¶„ÅÑ„Åæ„Åô</span>
        </p>
    </footer>

    <script>
        /**
         * === „Ç¢„Éó„É™„Ç±„Éº„Ç∑„Éß„É≥ÂàùÊúüÂåñ ===
         * Á∏¶Êõ∏„Åç„É°„É¢„Ç¢„Éó„É™ v1.8.0
         * 
         * v1.8.0 Â§âÊõ¥ÁÇπ:
         * - Content Security Policy (CSP) ÂÆüË£Ö
         * - „Çª„Ç≠„É•„É™„ÉÜ„Ç£„Éù„É™„Ç∑„ÉºÈÅïÂèç„ÅÆÊ§úÁü•Ê©üËÉΩËøΩÂä†
         * - Âç∞Âà∑Ê©üËÉΩ„Å∏„ÅÆCSPÈÅ©Áî®
         * 
         * ‰æùÂ≠ò: DOMÊßãÁØâÂÆå‰∫Ü
         * Â§ñÈÉ®„É©„Ç§„Éñ„É©„É™: Google Fonts‰ª•Â§ñ„ÅØ‰ΩøÁî®„Åó„Å™„ÅÑ
         * 
         * ‰∏ªË¶Å„Å™Áä∂ÊÖãÁÆ°ÁêÜ:
         * - markerState: „Éû„Éº„Ç´„ÉºÊ©üËÉΩ„ÅÆÁä∂ÊÖã
         * - scrollSyncState: „Çπ„ÇØ„É≠„Éº„É´ÂêåÊúü„ÅÆÁä∂ÊÖã
         * - APP_INFO: „Ç¢„Éó„É™„Ç±„Éº„Ç∑„Éß„É≥ÊÉÖÂ†±
         */
        
        'use strict';
        
        // === CSP„Ç®„É©„Éº„Éè„É≥„Éâ„É™„É≥„Ç∞ ===
        // Content Security PolicyÈÅïÂèç„ÇíÊ§úÁü•„Åó„Å¶Â†±Âëä
        if (typeof SecurityPolicyViolationEvent !== 'undefined') {
            document.addEventListener('securitypolicyviolation', (e) => {
                console.warn('CSPÈÅïÂèç„ÅåÊ§úÂá∫„Åï„Çå„Åæ„Åó„Åü:', {
                    blockedURI: e.blockedURI,
                    violatedDirective: e.violatedDirective,
                    originalPolicy: e.originalPolicy,
                    disposition: e.disposition
                });
                
                // ÊïôËÇ≤ÁèæÂ†¥„Åß„ÅÆ‰ΩøÁî®„ÇíËÄÉÊÖÆ„Åó„ÄÅ„Ç®„É©„Éº„ÅØÈùô„Åã„Å´Ë®òÈå≤
                // Êú¨Áï™Áí∞Â¢É„Åß„ÅØ„ÄÅ„Çµ„Éº„Éê„Éº„Å∏„ÅÆÂ†±Âëä„ÇíÂÆüË£Ö„Åô„Çã„Åì„Å®„ÇíÊé®Â•®
                // TODO: Â∞ÜÊù•ÁöÑ„Å´„ÅØCSP„É¨„Éù„Éº„Éà„Ç®„É≥„Éâ„Éù„Ç§„É≥„Éà„Å∏„ÅÆÈÄÅ‰ø°„ÇíÂÆüË£Ö
            });
        }
        
        // === ÂãïÁöÑ„Çπ„Ç±„Éº„É™„É≥„Ç∞„ÅÆË®≠ÂÆö ===
        // „Ç¶„Ç£„É≥„Éâ„Ç¶„Çµ„Ç§„Ç∫„Å´Âøú„Åò„Å¶UI„Çí„Çπ„Ç±„Éº„É™„É≥„Ç∞
        function updateScaleFactors() {
            const width = window.innerWidth;
            let baseScale = 1;
            let fontScale = 1;
            let uiScale = 1;
            
            // „Éñ„É¨„Éº„ÇØ„Éù„Ç§„É≥„Éà„ÅØÂÆüÊ©ü„ÉÜ„Çπ„Éà„Å´Âü∫„Å•„ÅèÂÄ§
            if (width >= 7680) { // 8K
                baseScale = 4;
                fontScale = 5;
                uiScale = 4;
            } else if (width >= 3840) { // 4K
                baseScale = 2;
                fontScale = 2.5;
                uiScale = 2;
            } else if (width >= 2560) { // WQHD
                baseScale = 1.5;
                fontScale = 1.75;
                uiScale = 1.5;
            } else if (width >= 1920) { // Full HD
                baseScale = 1.25;
                fontScale = 1.5;
                uiScale = 1.25;
            }
            
            // CSSÂ§âÊï∞„ÇíÊõ¥Êñ∞
            document.documentElement.style.setProperty('--base-scale', baseScale);
            document.documentElement.style.setProperty('--font-scale', fontScale);
            document.documentElement.style.setProperty('--ui-scale', uiScale);
            document.documentElement.style.setProperty('--min-touch-target', `${44 * uiScale}px`);
        }
        
        // ÂàùÊúüÂåñ„Å®„É™„Çµ„Ç§„Ç∫ÂØæÂøú
        updateScaleFactors();
        window.addEventListener('resize', updateScaleFactors);
        
        // „Ç¢„Éó„É™„Ç±„Éº„Ç∑„Éß„É≥ÊÉÖÂ†±„Çí„Ç≥„É≥„ÇΩ„Éº„É´„Å´Âá∫Âäõ
        console.log('Á∏¶Êõ∏„Åç„É°„É¢„Ç¢„Éó„É™ v1.8.0');
        console.log('Copyright (c) 2025 HarmoniaEpic');
        console.log('Licensed under the MIT License');
        console.log('„Ç™„Éï„É©„Ç§„É≥ÂØæÂøúÁâà - „Éç„ÉÉ„Éà„ÉØ„Éº„ÇØÊé•Á∂ö‰∏çË¶Å„ÅßÂãï‰Ωú„Åó„Åæ„Åô');
        console.log('v1.8.0: Content Security Policy (CSP) „Å´„Çà„Çã„Çª„Ç≠„É•„É™„ÉÜ„Ç£Âº∑Âåñ');
        
        // === CSP nonceÂØæÂøú„ÅÆÊ∫ñÂÇô ===
        // TODO: Â∞ÜÊù•ÁöÑ„Å™„Çª„Ç≠„É•„É™„ÉÜ„Ç£Âº∑Âåñ„ÅÆ„Åü„ÇÅ„ÄÅ‰ª•‰∏ã„ÅÆÂÆüË£Ö„ÇíÊ§úË®é
        // 1. „Çµ„Éº„Éê„Éº„Çµ„Ç§„Éâ„Åß„É©„É≥„ÉÄ„É†„Å™nonceÂÄ§„ÇíÁîüÊàê
        // 2. CSP„Éò„ÉÉ„ÉÄ„Éº„Å®script/style„Çø„Ç∞„Å´Âêå„ÅònonceÂÄ§„ÇíË®≠ÂÆö
        // 3. ÂãïÁöÑ„Å´ÁîüÊàê„Åï„Çå„ÇãË¶ÅÁ¥†„Å´„ÇÇnonceÂ±ûÊÄß„ÇíËøΩÂä†
        // 
        // ‰æã:
        // const nonce = document.querySelector('meta[name="csp-nonce"]')?.content;
        // if (nonce) {
        //     dynamicScript.setAttribute('nonce', nonce);
        // }
        
        // === Service WorkerÊ∫ñÂÇôÔºàÂ∞ÜÊù•ÁöÑ„Å™PWAÂÆüË£ÖÁî®Ôºâ ===
        // TODO: PWAÂåñ„Åô„ÇãÂ†¥Âêà„ÅØ‰ª•‰∏ã„ÇíÂÆüË£Ö
        // const CACHE_NAME = 'tategaki-memo-v1.8.0';
        // Service Worker„ÅÆÁôªÈå≤„Å®„Ç≠„É£„ÉÉ„Ç∑„É•Êà¶Áï•„ÅÆÂÆüË£Ö
        // „Ç™„Éï„É©„Ç§„É≥ÂØæÂøú„ÅÆÂº∑Âåñ
      
        // Service WorkerÊõ¥Êñ∞
        function updateServiceWorker() {
            if ('serviceWorker' in navigator) {
                navigator.serviceWorker.getRegistration().then((registration) => {
                    if (registration && registration.waiting) {
                        registration.waiting.postMessage({ type: 'SKIP_WAITING' });
                        window.location.reload();
                    }
                });
            }
        }
      
        // === „É°„Ç§„É≥„Ç¢„Éó„É™„Ç±„Éº„Ç∑„Éß„É≥ ===
        document.addEventListener('DOMContentLoaded', () => {
            // „Ç¢„Éó„É™„Ç±„Éº„Ç∑„Éß„É≥ÊÉÖÂ†±
            const APP_INFO = {
                name: 'Á∏¶Êõ∏„Åç„É°„É¢„Ç¢„Éó„É™',
                version: '1.8.0',
                author: 'HarmoniaEpic',
                license: 'MIT',
                changelog: {
                    'v1.8.0': 'Content Security Policy (CSP) ÂÆüË£Ö„Å´„Çà„Çã„Çª„Ç≠„É•„É™„ÉÜ„Ç£Âº∑Âåñ',
                    'v1.7.0': 'Âç∞Âà∑Ê©üËÉΩÊîπËâØÁâàÔºàÂàùÊúü„É™„É™„Éº„ÇπÔºâ'
                }
            };
            
            // === DOMË¶ÅÁ¥†„ÅÆÂèñÂæó ===
            const textInput = document.getElementById('text-input');
            const previewArea = document.getElementById('preview-area');
            const saveButton = document.getElementById('save-button');
            const loadButton = document.getElementById('load-button');
            const svgLoadInput = document.getElementById('svg-load-input');
            const togglePreview = document.getElementById('toggle-preview');
            const previewContainer = document.getElementById('preview-container');
            const mainContent = document.getElementById('main-content');
            const inputContainer = document.getElementById('input-container');
            const exportPngButton = document.getElementById('export-png-button');
            const pngMenuToggle = document.getElementById('png-menu-toggle');
            const pngMenu = document.getElementById('png-menu');
            const exportTransparentPngButton = document.getElementById('export-transparent-png-button');
            const printButton = document.getElementById('print-button');
            const alignmentSelector = document.getElementById('alignment-selector');
            const fontSelector = document.getElementById('font-selector');
            const fontSizeSelector = document.getElementById('font-size-selector');
            const textColorSelector = document.getElementById('text-color-selector');
            const colorPreview = document.getElementById('color-preview');
            const transparentPngInfo = document.getElementById('transparent-png-info');
            const wrapToggle = document.getElementById('wrap-toggle');
            const blackboardToggle = document.getElementById('blackboard-toggle');
            const fullscreenToggle = document.getElementById('fullscreen-toggle');
            const scrollSyncToggle = document.getElementById('scroll-sync-toggle');
            const scrollSyncToggleContainer = document.getElementById('scroll-sync-toggle-container');
            const saveMarkersToggle = document.getElementById('save-markers-toggle');
            const saveMarkersToggleContainer = document.getElementById('save-markers-toggle-container');
            const escKeyHint = document.getElementById('esc-key-hint');
            const markerModeToggleButton = document.getElementById('marker-mode-toggle-button');

            // „Éû„Éº„Ç´„ÉºÊ©üËÉΩ„ÅÆDOMË¶ÅÁ¥†
            const markerToggle = document.getElementById('marker-toggle');
            const markerPalette = document.getElementById('marker-palette');
            const markerColors = document.querySelectorAll('.marker-color');
            const markerClear = document.getElementById('marker-clear');

            // === Áä∂ÊÖãÁÆ°ÁêÜ„Ç™„Éñ„Ç∏„Çß„ÇØ„Éà ===
            
            /**
             * „Éû„Éº„Ç´„ÉºÊ©üËÉΩ„ÅÆÁä∂ÊÖãÁÆ°ÁêÜ
             * Êã°Âºµ„Éù„Ç§„É≥„Éà: Êñ∞„Åó„ÅÑ„Éó„É≠„Éë„ÉÜ„Ç£ËøΩÂä†ÊôÇ„ÅØÂàùÊúüÂåñ„ÇÇÂøò„Çå„Åö„Å´
             */
            const markerState = {
                isActive: false,        // „Éû„Éº„Ç´„Éº„É¢„Éº„Éâ„ÅÆÊúâÂäπ/ÁÑ°Âäπ
                currentColor: null,     // ÁèæÂú®ÈÅ∏Êäû‰∏≠„ÅÆËâ≤Ôºànull=Êú™ÈÅ∏ÊäûÔºâ
                markers: [],            // „Éû„Éº„Ç´„ÉºÊÉÖÂ†±ÈÖçÂàó [{id, start, end, color, text}]
                isDragging: false,      // „Éâ„É©„ÉÉ„Ç∞‰∏≠„Éï„É©„Ç∞ÔºàÂ∞ÜÊù•ÁöÑ„Å™Êã°ÂºµÁî®Ôºâ
                markerId: 0,            // ‰∏ÄÊÑè„Å™„Éû„Éº„Ç´„ÉºIDÁîüÊàêÁî®„Ç´„Ç¶„É≥„Çø
                lastUsedColor: '#FFFF00', // ÊúÄÂæå„Å´‰ΩøÁî®„Åó„ÅüËâ≤ÔºàUXÂêë‰∏äÁî®Ôºâ
                hasEverSelected: false    // Ëâ≤ÈÅ∏ÊäûÂ±•Ê≠¥ÔºàÂàùÊúüËâ≤Ê±∫ÂÆöÁî®Ôºâ
            };

            /**
             * „Çπ„ÇØ„É≠„Éº„É´ÂêåÊúü„ÅÆÁä∂ÊÖãÁÆ°ÁêÜ
             * Á∏¶Êõ∏„Åç„Å™„ÅÆ„ÅßÊ®™„Çπ„ÇØ„É≠„Éº„É´„ÅÆ„Åø„ÇíÂêåÊúü
             */
            const scrollSyncState = {
                isEnabled: true,          // ÂêåÊúüÊ©üËÉΩ„ÅÆÊúâÂäπ/ÁÑ°Âäπ
                isSyncing: false,         // ÂêåÊúüÂá¶ÁêÜ‰∏≠„Éï„É©„Ç∞ÔºàÁÑ°Èôê„É´„Éº„ÉóÈò≤Ê≠¢Ôºâ
                syncAnimationId: null,    // requestAnimationFrame„ÅÆID
                temporaryDisabled: false  // „Éû„Éº„Ç´„ÉºÊìç‰ΩúÊôÇ„ÅÆ‰∏ÄÊôÇÁÑ°ÂäπÂåñ
            };

        // === „Çπ„Çø„Ç§„É´ÈÅ©Áî®Èñ¢Êï∞ ===
        
        /**
         * ÊñáÂ≠óËâ≤Ë¶ãÊú¨„ÅÆË°®Á§∫„ÇíÊõ¥Êñ∞
         */
        function updateColorPreview() {
            const selectedOption = textColorSelector.options[textColorSelector.selectedIndex];
            const color = selectedOption.value;
            
            colorPreview.style.color = color;
            
            // ÁôΩ„Åæ„Åü„ÅØÈªÑËâ≤„ÅÆÂ†¥Âêà„ÅØË¶ñË™çÊÄß„ÅÆ„Åü„ÇÅÂΩ±„ÇíÂº∑Ë™ø
            if (color === '#FFFFFF' || color === '#FFFF00') {
                colorPreview.classList.add('color-preview-bordered');
            } else {
                colorPreview.classList.remove('color-preview-bordered');
            }
        }

        // === ÂàùÊúü„ÉÜ„Ç≠„Çπ„Éà„ÅÆË®≠ÂÆö ===
        const initialText = `Áî∑„ÇÇ„Åô„Å™„ÇãÊó•Ë®ò„Å®„ÅÑ„Åµ„ÇÇ„ÅÆ„Çí„ÄÅ
Â•≥„ÇÇ„Åó„Å¶„Åø„ÇÄ„Å®„Å¶„Åô„Çã„Å™„Çä„ÄÇ
„Åù„Çå„ÅÆÂπ¥„ÅÆ„ÄÅ„Åó„ÅØ„Åô„ÅÆ‰∫åÂçÅÊó•„ÅÇ„Åæ„Çä
„Å≤„Å®„Å≤„ÅÆÊó•„ÅÆ„ÄÅÊàå„ÅÆÂàª„Å´ÈñÄÂá∫„Åô„ÄÇ
„Åù„ÅÆ„Çà„Åó„ÄÅ„ÅÑ„Åï„Çù„Åã„ÇÇ„ÅÆ„Å´Êõ∏„Åç„Å§„Åè„ÄÇ`;
        textInput.value = initialText;
        updatePreviewWithMarkers();

        // === „Çπ„Çø„Ç§„É´ÈÅ©Áî®Èñ¢Êï∞Áæ§ ===
        function applyAlignment(alignment) {
            textInput.style.textAlign = alignment;
            previewArea.style.textAlign = alignment;
        }

        function applyFontFamily(fontFamily) {
            textInput.style.fontFamily = fontFamily;
            previewArea.style.fontFamily = fontFamily;
        }

        function applyFontSize(size) {
            // È´òËß£ÂÉèÂ∫¶Áí∞Â¢É„Åß„ÅÆ„Éï„Ç©„É≥„Éà„Çµ„Ç§„Ç∫Ëá™ÂãïË™øÊï¥
            const scale = parseFloat(getComputedStyle(document.documentElement).getPropertyValue('--font-scale'));
            const adjustedSize = Math.round(parseInt(size) * Math.min(scale, 2));
            const fontSize = adjustedSize + 'px';
            textInput.style.fontSize = fontSize;
            previewArea.style.fontSize = fontSize;
        }

        function applyTextColor(color) {
            textInput.style.color = color;
            
            // ÁôΩ„Åæ„Åü„ÅØÈªÑËâ≤„ÅÆÂ†¥Âêà„ÅÆÁâπÂà•Âá¶ÁêÜ
            if (color === '#FFFFFF' || color === '#FFFF00') {
                transparentPngInfo.classList.remove('hidden');
                
                if (togglePreview.checked) {
                    previewArea.classList.add('preview-gray-bg');
                }
                
                textInput.classList.add('text-shadow-for-white');
            } else {
                transparentPngInfo.classList.add('hidden');
                previewArea.classList.remove('preview-gray-bg');
                textInput.classList.remove('text-shadow-for-white');
            }
            
            updatePreviewWithMarkers();
        }

        function applyTextWrap(isWrapped) {
            const whiteSpaceValue = isWrapped ? 'normal' : 'pre';
            textInput.style.whiteSpace = whiteSpaceValue;
            previewArea.style.whiteSpace = whiteSpaceValue;
        }

        /**
         * ÁîªÈù¢„Çµ„Ç§„Ç∫„Å´Âøú„Åò„Åü„Éï„Ç©„É≥„Éà„Çµ„Ç§„Ç∫„ÅÆËá™ÂãïË™øÊï¥
         * Â§ßÁîªÈù¢„Åß„ÅØË¶ã„ÇÑ„Åô„Åï„ÅÆ„Åü„ÇÅËá™ÂãïÁöÑ„Å´Â§ß„Åç„ÇÅ„ÅÆ„Çµ„Ç§„Ç∫„ÇíË®≠ÂÆö
         */
        function adjustFontSizeForScreen() {
            const screenWidth = window.innerWidth;
            if (screenWidth >= 3840 && fontSizeSelector.value === '24') {
                fontSizeSelector.value = '56';
            } else if (screenWidth >= 1920 && fontSizeSelector.value === '24') {
                fontSizeSelector.value = '32';
            }
        }

        // === „Éû„Éº„Ç´„ÉºÊ©üËÉΩ„ÅÆÂÆüË£Ö ===
        
        /**
         * „Éû„Éº„Ç´„ÉºËâ≤„Åã„ÇâËñÑ„ÅÑËÉåÊôØËâ≤„ÇíÁîüÊàê
         * @param {string} color - „Éû„Éº„Ç´„Éº„ÅÆËâ≤„Ç≥„Éº„Éâ
         * @returns {string} ËñÑ„ÅÑËÉåÊôØËâ≤ÔºàRGBAÂΩ¢ÂºèÔºâ
         */
        function getLightMarkerColor(color) {
            const colorMap = {
                '#FFFF00': 'rgba(255, 255, 0, 0.2)',      // ÈªÑËâ≤
                '#FF6B6B': 'rgba(255, 107, 107, 0.2)',    // Ëµ§Ëâ≤
                '#4DABF7': 'rgba(77, 171, 247, 0.2)',     // ÈùíËâ≤
                '#51CF66': 'rgba(81, 207, 102, 0.2)',     // Á∑ëËâ≤
                '#CC5DE8': 'rgba(204, 93, 232, 0.2)',     // Á¥´Ëâ≤
                'transparent': 'transparent'                // Ê∂à„Åó„Ç¥„É†
            };
            return colorMap[color] || 'rgba(128, 128, 128, 0.2)';
        }

        /**
         * ESC„Ç≠„Éº„Éí„É≥„Éà„ÅÆ„Çπ„Çø„Ç§„É´„ÇíÊõ¥Êñ∞
         * „Éû„Éº„Ç´„Éº„É¢„Éº„Éâ„ÅÆÁä∂ÊÖã„Å´Âøú„Åò„Å¶Ë¶ñË¶öÁöÑ„Éï„Ç£„Éº„Éâ„Éê„ÉÉ„ÇØ„ÇíÊèê‰æõ
         */
        function updateEscKeyHintStyle() {
            const escHintButton = document.getElementById('marker-mode-toggle-button');
            if (markerState.isActive && markerState.currentColor) {
                if (markerState.currentColor === 'transparent') {
                    // Ê∂à„Åó„Ç¥„É†„É¢„Éº„ÉâÊôÇ
                    escHintButton.style.color = '#FFFFFF';
                    escHintButton.style.borderColor = '#9CA3AF';
                    escHintButton.style.backgroundColor = '#D1D5DB';
                    escHintButton.style.fontWeight = '600';
                    escHintButton.style.textShadow = '0 1px 2px rgba(0, 0, 0, 0.3)';
                } else {
                    // ÈÄöÂ∏∏„ÅÆ„Éû„Éº„Ç´„Éº„É¢„Éº„ÉâÊôÇ
                    const lightColor = getLightMarkerColor(markerState.currentColor);
                    escHintButton.style.color = '#000000';
                    escHintButton.style.borderColor = markerState.currentColor;
                    escHintButton.style.backgroundColor = lightColor;
                    escHintButton.style.fontWeight = '600';
                    escHintButton.style.textShadow = '1px 1px 2px rgba(0,0,0,0.1)';
                }
            } else {
                // „Éû„Éº„Ç´„Éº„É¢„Éº„ÉâOFFÊôÇ
                escHintButton.classList.add('text-gray-600', 'border-gray-400');
                escHintButton.style.color = '';
                escHintButton.style.borderColor = '';
                escHintButton.style.backgroundColor = 'transparent';
                escHintButton.style.fontWeight = '';
                escHintButton.style.textShadow = '1px 1px 2px rgba(0,0,0,0.1)';
            }
        }

        /**
         * ÁâπÂÆö„ÅÆËâ≤„Åß„Éû„Éº„Ç´„Éº„É¢„Éº„Éâ„ÇíÊúâÂäπÂåñ
         * @param {string} color - ÊúâÂäπÂåñ„Åô„ÇãËâ≤
         */
        function activateMarkerColor(color) {
            markerColors.forEach(btn => btn.classList.remove('active'));
            
            markerColors.forEach(button => {
                if (button.dataset.color === color) {
                    button.classList.add('active');
                }
            });
            
            markerState.isActive = true;
            markerState.currentColor = color;
            markerState.lastUsedColor = color;
            markerState.hasEverSelected = true;
            
            previewArea.classList.add('marker-mode');
            
            // „Éû„Éº„Ç´„Éº„É¢„Éº„Éâ‰∏≠„ÅØ„Çπ„ÇØ„É≠„Éº„É´ÂêåÊúü„Çí‰∏ÄÊôÇÁöÑ„Å´ÁÑ°ÂäπÂåñ
            scrollSyncState.temporaryDisabled = true;
            
            updateEscKeyHintStyle();
            updatePreviewWithMarkers();
        }

        /**
         * „Éû„Éº„Ç´„Éº„É¢„Éº„Éâ„ÅÆON/OFFÂàá„ÇäÊõø„Åà
         * ESC„Ç≠„Éº„Åæ„Åü„ÅØ„Éú„Çø„É≥„ÇØ„É™„ÉÉ„ÇØ„ÅßÂëº„Å∞„Çå„Çã
         */
        function toggleMarkerMode() {
            if (!togglePreview.checked) return;
            
            if (markerState.isActive) {
                // OFF
                markerState.isActive = false;
                markerState.currentColor = null;
                markerColors.forEach(btn => btn.classList.remove('active'));
                previewArea.classList.remove('marker-mode');
                scrollSyncState.temporaryDisabled = false;
                updateEscKeyHintStyle();
            } else {
                // ON
                const colorToUse = markerState.hasEverSelected ? markerState.lastUsedColor : '#FFFF00';
                activateMarkerColor(colorToUse);
                markerPalette.classList.remove('hidden');
            }
        }

        /**
         * „ÉÜ„Ç≠„Çπ„Éà„Å´„Éû„Éº„Ç´„Éº„ÇíÈÅ©Áî®„Åó„Å¶Ë°®Á§∫
         * IMPORTANT: „Éû„Éº„Ç´„Éº„Åå„Å™„ÅÑÂ†¥Âêà„ÇÇÊñáÂ≠óËâ≤„ÅØÈÅ©Áî®„Åô„Çã
         */
        function updatePreviewWithMarkers() {
            const text = textInput.value;
            const textColor = textColorSelector.value;
            
            if (!text) {
                previewArea.innerHTML = '<span class="text-gray-400">„ÉÜ„Ç≠„Çπ„Éà„Åå„ÅÇ„Çä„Åæ„Åõ„Çì</span>';
                return;
            }
            
            // Âü∫Êú¨„ÅÆÊñáÂ≠óËâ≤„Çπ„Çø„Ç§„É´
            const baseStyle = `color: ${textColor};`;
            const needsShadow = (textColor === '#FFFFFF' || textColor === '#FFFF00');
            const shadowStyle = needsShadow ? ' text-shadow: 0 0 3px rgba(0, 0, 0, 0.3);' : '';
            
            if (markerState.markers.length === 0) {
                previewArea.innerHTML = `<span style="${baseStyle}${shadowStyle}">${escapeHtml(text)}</span>`;
                return;
            }
            
            // „Éû„Éº„Ç´„Éº„Çí‰ΩçÁΩÆÈ†Ü„Å´„ÇΩ„Éº„Éà
            const sortedMarkers = [...markerState.markers].sort((a, b) => a.start - b.start);
            
            let html = '';
            let lastEnd = 0;
            
            sortedMarkers.forEach(marker => {
                // „Éû„Éº„Ç´„ÉºÂâç„ÅÆ„ÉÜ„Ç≠„Çπ„Éà
                if (marker.start > lastEnd) {
                    html += `<span style="${baseStyle}${shadowStyle}">${escapeHtml(text.substring(lastEnd, marker.start))}</span>`;
                }
                
                // „Éû„Éº„Ç´„ÉºÈÉ®ÂàÜ
                if (marker.color === 'transparent') {
                    html += `<span style="${baseStyle}${shadowStyle}">${escapeHtml(text.substring(marker.start, marker.end))}</span>`;
                } else {
                    const colorClass = getMarkerClass(marker.color);
                    html += `<span class="${colorClass}" style="${baseStyle}${shadowStyle}">${escapeHtml(text.substring(marker.start, marker.end))}</span>`;
                }
                
                lastEnd = marker.end;
            });
            
            // ÊúÄÂæå„ÅÆÈÉ®ÂàÜ
            if (lastEnd < text.length) {
                html += `<span style="${baseStyle}${shadowStyle}">${escapeHtml(text.substring(lastEnd))}</span>`;
            }
            
            previewArea.innerHTML = html;
        }
        
        /**
         * HTML„Ç®„Çπ„Ç±„Éº„ÉóÂá¶ÁêÜ
         * @param {string} text - „Ç®„Çπ„Ç±„Éº„Éó„Åô„Çã„ÉÜ„Ç≠„Çπ„Éà
         * @returns {string} „Ç®„Çπ„Ç±„Éº„ÉóÊ∏à„Åø„ÉÜ„Ç≠„Çπ„Éà
         */
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
        
        /**
         * Ëâ≤„Ç≥„Éº„Éâ„Åã„Çâ„Éû„Éº„Ç´„Éº„ÇØ„É©„ÇπÂêç„ÇíÂèñÂæó
         * @param {string} color - Ëâ≤„Ç≥„Éº„Éâ
         * @returns {string} CSS„ÇØ„É©„ÇπÂêç
         */
        function getMarkerClass(color) {
            const colorMap = {
                '#FFFF00': 'marker-yellow',
                '#FF6B6B': 'marker-red',
                '#4DABF7': 'marker-blue',
                '#51CF66': 'marker-green',
                '#CC5DE8': 'marker-purple'
            };
            return colorMap[color] || '';
        }
        
        /**
         * „ÉÜ„Ç≠„Çπ„ÉàÈÅ∏ÊäûÊôÇ„ÅÆÂá¶ÁêÜ
         * ÈÅ∏ÊäûÁØÑÂõ≤„Å´„Éû„Éº„Ç´„Éº„ÇíÈÅ©Áî®
         */
        function handleTextSelection() {
            if (!markerState.isActive || !markerState.currentColor) return;
            
            const selection = window.getSelection();
            if (selection.rangeCount === 0) return;
            
            const selectedText = selection.toString();
            if (selectedText.length === 0) return;
            
            const plainText = textInput.value || '';
            
            // ÈÅ∏ÊäûÁØÑÂõ≤„ÅÆ‰ΩçÁΩÆ„ÇíÁâπÂÆö
            const range = selection.getRangeAt(0);
            const preSelectionRange = range.cloneRange();
            preSelectionRange.selectNodeContents(previewArea);
            preSelectionRange.setEnd(range.startContainer, range.startOffset);
            
            const preSelectionText = preSelectionRange.toString();
            const start = preSelectionText.length;
            const end = start + selectedText.length;
            
            // ÁØÑÂõ≤„ÉÅ„Çß„ÉÉ„ÇØ
            if (start < 0 || end > plainText.length) {
                selection.removeAllRanges();
                return;
            }
            
            // Êñ∞„Åó„ÅÑ„Éû„Éº„Ç´„Éº„ÇíËøΩÂä†
            const newMarker = {
                id: ++markerState.markerId,
                start: start,
                end: end,
                color: markerState.currentColor,
                text: selectedText
            };
            
            // ÈáçË§áÂá¶ÁêÜÔºöÊñ∞„Åó„ÅÑ„Éû„Éº„Ç´„Éº„ÅåÂÑ™ÂÖà
            markerState.markers = markerState.markers.filter(marker => 
                !(marker.start < end && marker.end > start)
            );
            
            markerState.markers.push(newMarker);
            
            updatePreviewWithMarkers();
            selection.removeAllRanges();
            
            // „Çπ„ÇØ„É≠„Éº„É´ÂêåÊúü„ÇíÂÜçÈñã
            scrollSyncState.temporaryDisabled = false;
        }
        
        // === „Éû„Éº„Ç´„ÉºUI„Ç§„Éô„É≥„Éà ===
        
        // „Éû„Éº„Ç´„Éº„É°„Éã„É•„Éº„ÅÆ„Éà„Ç∞„É´
        markerToggle.addEventListener('click', (e) => {
            e.stopPropagation();
            markerPalette.classList.toggle('hidden');
        });
        
        // PNG„É°„Éã„É•„Éº„ÅÆË°®Á§∫/ÈùûË°®Á§∫
        pngMenuToggle.addEventListener('click', (e) => {
            e.stopPropagation();
            pngMenu.classList.toggle('hidden');
        });
        
        // ÈÄèÈÅéPNG„Ç®„ÇØ„Çπ„Éù„Éº„Éà
        exportTransparentPngButton.addEventListener('click', (e) => {
            e.stopPropagation();
            pngMenu.classList.add('hidden');
            exportToPNG(true);
        });
        
        // „Éâ„Ç≠„É•„É°„É≥„Éà„ÇØ„É™„ÉÉ„ÇØ„Åß„É°„Éã„É•„Éº„ÇíÈñâ„Åò„Çã
        document.addEventListener('click', (e) => {
            if (!markerToggle.contains(e.target) && !markerPalette.contains(e.target)) {
                markerPalette.classList.add('hidden');
            }
            if (!pngMenuToggle.contains(e.target) && !pngMenu.contains(e.target)) {
                pngMenu.classList.add('hidden');
            }
        });
        
        // === ÂÖ®ÁîªÈù¢Ê©üËÉΩ ===
        fullscreenToggle.addEventListener('click', () => {
            if (!document.fullscreenElement && !document.webkitFullscreenElement && !document.mozFullScreenElement) {
                // ÂÖ®ÁîªÈù¢„Å´ÂÖ•„Çã
                const elem = document.documentElement;
                if (elem.requestFullscreen) {
                    elem.requestFullscreen();
                } else if (elem.webkitRequestFullscreen) {
                    elem.webkitRequestFullscreen();
                } else if (elem.mozRequestFullScreen) {
                    elem.mozRequestFullScreen();
                }
            } else {
                // ÂÖ®ÁîªÈù¢„Åã„ÇâÂá∫„Çã
                if (document.exitFullscreen) {
                    document.exitFullscreen();
                } else if (document.webkitExitFullscreen) {
                    document.webkitExitFullscreen();
                } else if (document.mozCancelFullScreen) {
                    document.mozCancelFullScreen();
                }
            }
        });
        
        /**
         * ÂÖ®ÁîªÈù¢Áä∂ÊÖã„Å´Âøú„Åò„Å¶„Ç¢„Ç§„Ç≥„É≥„ÇíÂàá„ÇäÊõø„Åà
         */
        function updateFullscreenIcon() {
            const expandIcon = document.getElementById('expand-icon');
            const shrinkIcon = document.getElementById('shrink-icon');
            
            if (document.fullscreenElement || document.webkitFullscreenElement || document.mozFullScreenElement) {
                expandIcon.style.display = 'none';
                shrinkIcon.style.display = 'block';
                fullscreenToggle.title = '„Ç¶„Ç£„É≥„Éâ„Ç¶Ë°®Á§∫„Å´Êàª„Çã';
                document.body.classList.add('fullscreen-active');
            } else {
                expandIcon.style.display = 'block';
                shrinkIcon.style.display = 'none';
                fullscreenToggle.title = 'ÂÖ®ÁîªÈù¢Ë°®Á§∫';
                document.body.classList.remove('fullscreen-active');
            }
        }
        
        // ÂÖ®ÁîªÈù¢„Ç§„Éô„É≥„Éà„É™„Çπ„Éä„Éº
        document.addEventListener('fullscreenchange', updateFullscreenIcon);
        document.addEventListener('webkitfullscreenchange', updateFullscreenIcon);
        document.addEventListener('mozfullscreenchange', updateFullscreenIcon);
        
        // Ëâ≤ÈÅ∏ÊäûÔºàÊ∂à„Åó„Ç¥„É†Âê´„ÇÄÔºâ
        markerColors.forEach(button => {
            button.addEventListener('click', (e) => {
                e.stopPropagation();
                
                markerColors.forEach(btn => btn.classList.remove('active'));
                button.classList.add('active');
                
                const color = button.dataset.color;
                activateMarkerColor(color);
                
                markerPalette.classList.add('hidden');
            });
        });
        
        // „Éû„Éº„Ç´„Éº„ÇØ„É™„Ç¢
        markerClear.addEventListener('click', (e) => {
            e.stopPropagation();
            
            if (confirm('„Åô„Åπ„Å¶„ÅÆ„Éû„Éº„Ç´„Éº„Çí„ÇØ„É™„Ç¢„Åó„Åæ„Åô„ÅãÔºü')) {
                markerState.markers = [];
                markerState.isActive = false;
                markerState.currentColor = null;
                
                markerColors.forEach(btn => btn.classList.remove('active'));
                previewArea.classList.remove('marker-mode');
                scrollSyncState.temporaryDisabled = false;
                updateEscKeyHintStyle();
                updatePreviewWithMarkers();
                markerPalette.classList.add('hidden');
            }
        });
        
        // „Éó„É¨„Éì„É•„Éº„Ç®„É™„Ç¢„Åß„ÅÆ„Éû„Ç¶„Çπ„Ç¢„ÉÉ„Éó„Ç§„Éô„É≥„Éà
        previewArea.addEventListener('mouseup', handleTextSelection);
        
        // „Çø„ÉÉ„ÉÅ„Éá„Éê„Ç§„ÇπÂØæÂøú
        previewArea.addEventListener('touchend', handleTextSelection);
        
        // „Ç≠„Éº„Éú„Éº„Éâ„Ç∑„Éß„Éº„Éà„Ç´„ÉÉ„Éà
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                toggleMarkerMode();
            }
            
            // F11„Ç≠„Éº„ÅßÂÖ®ÁîªÈù¢Âàá„ÇäÊõø„Åà
            if (e.key === 'F11') {
                e.preventDefault();
                fullscreenToggle.click();
            }
        });
        
        // ESC„Ç≠„Éº„Éí„É≥„Éà„Éú„Çø„É≥„ÅÆ„ÇØ„É™„ÉÉ„ÇØ„Ç§„Éô„É≥„Éà
        markerModeToggleButton.addEventListener('click', (e) => {
            e.stopPropagation();
            toggleMarkerMode();
        });
        
        // === UI„Ç≥„É≥„Éà„É≠„Éº„É´„ÅÆ„Ç§„Éô„É≥„Éà„É™„Çπ„Éä„Éº ===
        alignmentSelector.addEventListener('change', (e) => applyAlignment(e.target.value));
        fontSelector.addEventListener('change', (e) => applyFontFamily(e.target.value));
        fontSizeSelector.addEventListener('change', (e) => applyFontSize(e.target.value));
        textColorSelector.addEventListener('change', (e) => {
            applyTextColor(e.target.value);
            updateColorPreview();
        });
        wrapToggle.addEventListener('change', (e) => applyTextWrap(e.target.checked));
        
        // ÈªíÊùø„É¢„Éº„Éâ„ÅÆ„Éà„Ç∞„É´
        blackboardToggle.addEventListener('change', (e) => {
            if (e.target.checked) {
                document.body.classList.add('blackboard-mode');
                // IMPORTANT: ÈªíÊùø„É¢„Éº„ÉâÊôÇ„ÅØÊñáÂ≠óËâ≤„ÇíËá™ÂãïÁöÑ„Å´ÁôΩ„Å´Â§âÊõ¥
                // „É¶„Éº„Ç∂„Éì„É™„ÉÜ„Ç£„ÇíËÄÉÊÖÆ„Åó„ÄÅÂÖÉ„ÅÆËâ≤„ÅØ‰øùÂ≠ò„Åó„Å¶Âæ©ÂÖÉÂèØËÉΩ„Å´„Åô„Çã
                const currentColor = textColorSelector.value;
                if (currentColor !== '#FFFFFF') {
                    document.body.dataset.previousColor = currentColor;
                    for (let i = 0; i < textColorSelector.options.length; i++) {
                        if (textColorSelector.options[i].value === '#FFFFFF') {
                            textColorSelector.selectedIndex = i;
                            applyTextColor('#FFFFFF');
                            updateColorPreview();
                            break;
                        }
                    }
                }
            } else {
                document.body.classList.remove('blackboard-mode');
                // Ââç„ÅÆËâ≤„Å´Êàª„Åô
                const previousColor = document.body.dataset.previousColor;
                if (previousColor && previousColor !== '#FFFFFF') {
                    for (let i = 0; i < textColorSelector.options.length; i++) {
                        if (textColorSelector.options[i].value === previousColor) {
                            textColorSelector.selectedIndex = i;
                            applyTextColor(previousColor);
                            updateColorPreview();
                            break;
                        }
                    }
                    delete document.body.dataset.previousColor;
                }
            }
        });
        
        // === ÂàùÊúü„Çπ„Çø„Ç§„É´„ÅÆÈÅ©Áî® ===
        applyAlignment(alignmentSelector.value);
        applyFontFamily(fontSelector.value);
        adjustFontSizeForScreen();
        applyFontSize(fontSizeSelector.value);
        applyTextColor(textColorSelector.value);
        updateColorPreview();
        applyTextWrap(wrapToggle.checked);

        // === „Ç¶„Ç£„É≥„Éâ„Ç¶„É™„Çµ„Ç§„Ç∫ÊôÇ„ÅÆÂá¶ÁêÜ ===
        let resizeTimer;
        window.addEventListener('resize', () => {
            clearTimeout(resizeTimer);
            resizeTimer = setTimeout(() => {
                updateScaleFactors();
                applyFontSize(fontSizeSelector.value);
            }, 250);
        });

        // „É©„Ç§„Éñ„Éó„É¨„Éì„É•„ÉºÊ©üËÉΩ
        textInput.addEventListener('input', () => {
            updatePreviewWithMarkers();
        });

        // === „Éó„É¨„Éì„É•„ÉºË°®Á§∫ÂàáÊõøÊ©üËÉΩ ===
        togglePreview.addEventListener('change', () => {
            if (togglePreview.checked) {
                previewContainer.classList.remove('hidden');
                mainContent.classList.remove('md:grid-cols-1');
                mainContent.classList.add('md:grid-cols-2');
                inputContainer.classList.remove('md:col-span-2');
                scrollSyncToggleContainer.classList.remove('hidden');
                saveMarkersToggleContainer.classList.remove('hidden');
                escKeyHint.classList.remove('hidden');
                updateEscKeyHintStyle();
                // ÁôΩ/ÈªÑËâ≤ÈÅ∏ÊäûÊôÇ„ÅÆËÉåÊôØËâ≤ÈÅ©Áî®
                const currentColor = textColorSelector.value;
                if (currentColor === '#FFFFFF' || currentColor === '#FFFF00') {
                    previewArea.classList.add('preview-gray-bg');
                }
                setupScrollSync();
                // „Éó„É¨„Éì„É•„ÉºË°®Á§∫ÊôÇ„Å´„Çπ„ÇØ„É≠„Éº„É´‰ΩçÁΩÆ„ÇíÂêåÊúü
                setTimeout(() => {
                    syncScroll(textInput, previewArea);
                }, 100);
            } else {
                previewContainer.classList.add('hidden');
                mainContent.classList.remove('md:grid-cols-2');
                mainContent.classList.add('md:grid-cols-1');
                inputContainer.classList.add('md:col-span-2');
                scrollSyncToggleContainer.classList.add('hidden');
                saveMarkersToggleContainer.classList.add('hidden');
                escKeyHint.classList.add('hidden');
                previewArea.classList.remove('preview-gray-bg');
                setupScrollSync();
            }
        });

        // === SVGÁîüÊàêÈñ¢Êï∞ ===
        
        /**
         * ÊñáÂ≠ó‰ΩçÁΩÆ„ÇíSVGÂ∫ßÊ®ôÁ≥ª„ÅßË®àÁÆó
         * @param {number} charIndex - ÊñáÂ≠ó„ÅÆ„Ç§„É≥„Éá„ÉÉ„ÇØ„Çπ
         * @param {string} text - ÂÖ®‰Ωì„ÅÆ„ÉÜ„Ç≠„Çπ„Éà
         * @param {number} fontSize - „Éï„Ç©„É≥„Éà„Çµ„Ç§„Ç∫
         * @param {number} charMargin - ÊñáÂ≠óÈñìÈöîÔºàÁèæÂú®„ÅØ0Âõ∫ÂÆöÔºâ
         * @param {number} lineSpacing - Ë°åÈñìÈöî
         * @param {number} padding - „Éë„Éá„Ç£„É≥„Ç∞
         * @param {string} alignment - ÊñáÂ≠óÊèÉ„Åà
         * @returns {Object|null} Â∫ßÊ®ôÊÉÖÂ†± {x, y, lineIndex, charInLine}
         */
        function getCharPositionInSVG(charIndex, text, fontSize, charMargin, lineSpacing, padding, alignment) {
            const lines = text.split('\n');
            let currentIndex = 0;
            
            for (let lineIndex = 0; lineIndex < lines.length; lineIndex++) {
                const line = lines[lineIndex];
                const lineLength = line.length;
                
                if (charIndex < currentIndex + lineLength) {
                    const charInLine = charIndex - currentIndex;
                    const x = padding + (lines.length - 1 - lineIndex) * lineSpacing;
                    
                    // ÊñáÂ≠óÊèÉ„Åà„Å´„Çà„Çã„Ç™„Éï„Çª„ÉÉ„ÉàË®àÁÆó
                    const longestLineLength = lines.reduce((max, l) => Math.max(max, l.length), 0);
                    const contentHeight = longestLineLength * fontSize;
                    const thisLineHeight = lineLength * fontSize;
                    
                    let yOffset = 0;
                    if (alignment === 'center') {
                        yOffset = (contentHeight - thisLineHeight) / 2;
                    } else if (alignment === 'right') {
                        yOffset = contentHeight - thisLineHeight;
                    }
                    
                    const y = padding + yOffset + charInLine * fontSize;
                    
                    return { x, y, lineIndex, charInLine };
                }
                
                currentIndex += lineLength;
                if (lineIndex < lines.length - 1) {
                    currentIndex++; // ÊîπË°åÊñáÂ≠ó
                }
            }
            
            return null;
        }

        /**
         * SVGÊñáÂ≠óÂàó„ÇíÁîüÊàê
         * @returns {Object|null} SVG„Éá„Éº„Çø {svgString, width, height}
         */
        function createSvgString() {
            const text = textInput.value;
            if (!text) return null;

            const alignment = alignmentSelector.value;
            const selectedFontFamily = fontSelector.value;
            const textColor = textColorSelector.value;
            const isBlackboardMode = document.body.classList.contains('blackboard-mode');
            const backgroundColor = isBlackboardMode ? '#1B4332' : 'white';
            const computedStyle = window.getComputedStyle(textInput);
            const fontSize = parseInt(computedStyle.fontSize);
            const lines = text.split('\n');
            
            const charMargin = 0; // ÊñáÂ≠óÈñìÈöî„Çí0„Å´Ë®≠ÂÆöÔºàÁ∏¶Êõ∏„Åç„ÅÆÊ®ôÊ∫ñÔºâ
            const lineSpacing = Math.round(fontSize * 1.25);
            const padding = Math.round(fontSize * 1.6);

            const longestLineLength = lines.reduce((max, line) => Math.max(max, line.length), 0);
            const contentHeight = longestLineLength * fontSize;
            const svgHeight = contentHeight + padding * 2;
            
            const svgWidth = lines.length * lineSpacing + padding * 2;
            
            // „Éû„Éº„Ç´„ÉºÊÉÖÂ†±„ÇíSVG„Å´Âê´„ÇÅ„Çã„Åã„Å©„ÅÜ„Åã
            const includeMarkers = saveMarkersToggle.checked && markerState.markers.length > 0;
            
            let svgContent = '';
            
            // „Éû„Éº„Ç´„Éº„ÅÆ„É¨„É≥„ÉÄ„É™„É≥„Ç∞
            if (includeMarkers) {
                svgContent += '<g id="markers">\n';
                
                markerState.markers.forEach(marker => {
                    if (marker.color === 'transparent') return;
                    
                    // „Éû„Éº„Ç´„Éº„ÅÆÁØÑÂõ≤ÂÜÖ„ÅÆÂêÑÊñáÂ≠ó„Å´ÂØæ„Åó„Å¶Áü©ÂΩ¢„ÇíÁîüÊàê
                    for (let i = marker.start; i < marker.end; i++) {
                        const pos = getCharPositionInSVG(i, text, fontSize, charMargin, lineSpacing, padding, alignment);
                        if (pos) {
                            const rectX = pos.x - fontSize * 0.1;
                            const rectY = pos.y;
                            const rectWidth = fontSize * 1.2;
                            const rectHeight = fontSize;
                            
                            svgContent += `  <rect x="${rectX}" y="${rectY}" width="${rectWidth}" height="${rectHeight}" fill="${marker.color}" opacity="0.4" />\n`;
                        }
                    }
                });
                
                svgContent += '</g>\n';
            }
            
            // „ÉÜ„Ç≠„Çπ„Éà„ÅÆ„É¨„É≥„ÉÄ„É™„É≥„Ç∞
            svgContent += '<g id="texts">\n';
            lines.forEach((line, index) => {
                const x = svgWidth - padding - (index * lineSpacing);
                const thisLineHeight = line.length * fontSize;
                
                let y = padding;
                if (alignment === 'center') {
                    y = padding + (contentHeight - thisLineHeight) / 2;
                } else if (alignment === 'right') {
                    y = padding + (contentHeight - thisLineHeight);
                }

                const sanitizedLine = line.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;').replace(/'/g, '&#039;');
                svgContent += `  <text x="${x}" y="${y}" writing-mode="vertical-rl" text-orientation="upright" dominant-baseline="text-before-edge">${sanitizedLine}</text>\n`;
            });
            svgContent += '</g>\n';
            
            // „É°„Çø„Éá„Éº„Çø
            let metadataContent = '';
            if (includeMarkers) {
                metadataContent = `
    <metadata>
        <markers>
            ${markerState.markers.map(m => 
                `<marker id="${m.id}" start="${m.start}" end="${m.end}" color="${m.color}" />`
            ).join('\n            ')}
        </markers>
    </metadata>`;
            }
            
            metadataContent += `
    <metadata>
        <textColor>${textColor}</textColor>
        <blackboardMode>${isBlackboardMode}</blackboardMode>
    </metadata>`;
            
            const svgString = `<?xml version="1.0" encoding="UTF-8"?>
<!-- Generated by Á∏¶Êõ∏„Åç„É°„É¢„Ç¢„Éó„É™ v${APP_INFO.version} -->
<!-- Generator software: ${APP_INFO.name} (${APP_INFO.license} License) -->
<!-- Generated at: ${new Date().toISOString()} -->
<!-- Security: Content Security Policy (CSP) enabled since v1.8.0 -->
<svg width="${svgWidth}" height="${svgHeight}" xmlns="http://www.w3.org/2000/svg" style="background-color: ${backgroundColor};">${metadataContent}
    <style>
        text {
            font-family: ${selectedFontFamily};
            font-size: ${fontSize}px;
            fill: ${textColor};
        }
    </style>
    ${svgContent}
</svg>`;
            return { svgString, width: svgWidth, height: svgHeight };
        }

        /**
         * „Éú„Çø„É≥„Å´„Ç®„É©„Éº„É°„ÉÉ„Çª„Éº„Ç∏„ÇíË°®Á§∫
         * @param {HTMLElement} button - ÂØæË±°„Éú„Çø„É≥
         * @param {string} message - „Ç®„É©„Éº„É°„ÉÉ„Çª„Éº„Ç∏
         */
        function showButtonError(button, message) {
            const originalText = button.innerText;
            button.innerText = message;
            button.classList.add('bg-red-500', 'hover:bg-red-600');
            setTimeout(() => {
                button.innerText = originalText;
                button.classList.remove('bg-red-500', 'hover:bg-red-600');
            }, 2000);
        }

        // === SVG‰øùÂ≠òÊ©üËÉΩ ===
        saveButton.addEventListener('click', () => {
            const svgData = createSvgString();
            if (!svgData) {
                showButtonError(saveButton, '„ÉÜ„Ç≠„Çπ„Éà„Åå„ÅÇ„Çä„Åæ„Åõ„Çì');
                return;
            }

            const blob = new Blob([svgData.svgString], { type: 'image/svg+xml;charset=utf-8' });
            // Blob URL„ÅÆ‰ΩúÊàêÔºàCSP„ÅßË®±ÂèØ„Åï„Çå„Åü„É™„ÇΩ„Éº„ÇπÔºâ
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            // „Çø„Ç§„É†„Çπ„Çø„É≥„Éó‰ªò„Åç„Éï„Ç°„Ç§„É´ÂêçÁîüÊàê
            const now = new Date();
            const dateStr = now.toLocaleDateString('ja-JP').replace(/\//g, '-');
            const timeStr = now.toLocaleTimeString('ja-JP', {hour: '2-digit', minute: '2-digit'}).replace(/:/g, '-');
            a.download = `Á∏¶Êõ∏„Åç„É°„É¢_${dateStr}_${timeStr}.svg`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        });

        // === PNG„Ç®„ÇØ„Çπ„Éù„Éº„ÉàÊ©üËÉΩ ===
        
        /**
         * PNG„Ç®„ÇØ„Çπ„Éù„Éº„ÉàÂá¶ÁêÜ
         * @param {boolean} transparent - ÈÄèÈÅéPNG„Åã„Å©„ÅÜ„Åã
         */
        function exportToPNG(transparent = false) {
            const svgData = createSvgString();
            if (!svgData) {
                showButtonError(transparent ? exportTransparentPngButton : exportPngButton, '„ÉÜ„Ç≠„Çπ„Éà„Åå„ÅÇ„Çä„Åæ„Åõ„Çì');
                return;
            }

            const textColor = textColorSelector.value;
            const isWhiteOrYellow = (textColor === '#FFFFFF' || textColor === '#FFFF00');
            
            // ÁôΩ/ÈªÑËâ≤ÈÅ∏ÊäûÊôÇ„ÅÆÁ¢∫Ë™ç„ÉÄ„Ç§„Ç¢„É≠„Ç∞
            if (!transparent && isWhiteOrYellow) {
                const result = confirm(
                    'ÁôΩ/ÈªÑËâ≤„ÅÆÊñáÂ≠ó„ÅØËÉåÊôØ„ÅåÁôΩ„Å†„Å®Ë¶ã„Åà„Å´„Åè„Åè„Å™„Çä„Åæ„Åô„ÄÇ\n' +
                    'ÈÄèÈÅéPNG„Åß„Ç®„ÇØ„Çπ„Éù„Éº„Éà„Åô„Çã„Åì„Å®„ÇíÊé®Â•®„Åó„Åæ„Åô„ÄÇ\n\n' +
                    'ÈÄèÈÅéPNG„Åß„Ç®„ÇØ„Çπ„Éù„Éº„Éà„Åó„Åæ„Åô„ÅãÔºü'
                );
                
                if (result) {
                    exportToPNG(true);
                    return;
                }
            }

            let { svgString, width, height } = svgData;
            
            // ÈÄèÈÅéPNG„ÅÆÂ†¥Âêà„ÄÅËÉåÊôØËâ≤„ÇíÂâäÈô§
            if (transparent) {
                svgString = svgString.replace(/style="background-color: [^"]*;"/, 'style="background-color: transparent;"');
            }

            // Â§ß„Åç„Å™ÁîªÂÉè„ÅÆË≠¶Âëä
            if (width > 4096 || height > 4096) {
                if (!confirm(`ÁîüÊàê„Åï„Çå„ÇãÁîªÂÉè„ÅåÂ§ß„Åç„ÅÑ„Åß„ÅôÔºà${width}x${height}pxÔºâ„ÄÇÁ∂öË°å„Åó„Åæ„Åô„ÅãÔºü`)) {
                    return;
                }
            }

            // Blob URL„ÅÆ‰ΩúÊàêÔºàCSP„ÅÆimg-src: blob:„Å´„Çà„ÇäË®±ÂèØÔºâ
            // IMPORTANT: ‰ΩøÁî®Âæå„ÅØÂøÖ„ÅörevokeObjectURL„Åß„É°„É¢„É™„ÇíËß£Êîæ
            const svgBlob = new Blob([svgString], {type: 'image/svg+xml;charset=utf-8'});
            const url = URL.createObjectURL(svgBlob);
            
            const img = new Image();
            img.onload = () => {
                const canvas = document.createElement('canvas');
                canvas.width = width;
                canvas.height = height;
                const ctx = canvas.getContext('2d');
                
                if (transparent) {
                    ctx.clearRect(0, 0, width, height);
                } else if (document.body.classList.contains('blackboard-mode')) {
                    ctx.fillStyle = '#1B4332';
                    ctx.fillRect(0, 0, width, height);
                }
                
                ctx.drawImage(img, 0, 0);

                const pngUrl = canvas.toDataURL('image/png');
                const a = document.createElement('a');
                a.href = pngUrl;
                // „Çø„Ç§„É†„Çπ„Çø„É≥„Éó‰ªò„Åç„Éï„Ç°„Ç§„É´ÂêçÁîüÊàê
                const now = new Date();
                const dateStr = now.toLocaleDateString('ja-JP').replace(/\//g, '-');
                const timeStr = now.toLocaleTimeString('ja-JP', {hour: '2-digit', minute: '2-digit'}).replace(/:/g, '-');
                const transparentSuffix = transparent ? '_ÈÄèÈÅé' : '';
                a.download = `Á∏¶Êõ∏„Åç„É°„É¢${transparentSuffix}_${dateStr}_${timeStr}.png`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);

                URL.revokeObjectURL(url);
            };
            img.onerror = (e) => {
                console.error("PNG„Å∏„ÅÆ„Ç®„ÇØ„Çπ„Éù„Éº„Éà‰∏≠„Å´ÁîªÂÉè„ÅÆË™≠„ÅøËæº„Åø„Å´Â§±Êïó„Åó„Åæ„Åó„Åü„ÄÇ", e);
                showButtonError(transparent ? exportTransparentPngButton : exportPngButton, "„Ç®„ÇØ„Çπ„Éù„Éº„ÉàÂ§±Êïó");
                URL.revokeObjectURL(url);
            };
            img.src = url;
        }

        exportPngButton.addEventListener('click', () => {
            exportToPNG(false);
        });

        // === Âç∞Âà∑Ê©üËÉΩÂÆüË£Ö ===
        
        // Âç∞Âà∑Èñ¢ÈÄ£„ÅÆÂÆöÊï∞ÔºàA4Áî®Á¥ôÂü∫Ê∫ñÔºâ
        const PRINT_CONSTANTS = {
            PX_TO_MM: 0.2645833,         // 1px = 0.265mm (96DPI)
            COLUMN_SPACING_RATIO: -0.25,  // ÂàóÈñìÈöî„ÇíÊñáÂ≠ó„Çµ„Ç§„Ç∫„ÅÆ-25%„Å´Ë®≠ÂÆö
            PAGE_WIDTH_MM: 180,           // A4Á∏¶„ÅÆÂç∞Âà∑ÂèØËÉΩÂπÖÔºà‰ΩôÁôΩËÄÉÊÖÆÔºâ
            PAGE_HEIGHT_MM: 267,          // A4Á∏¶„ÅÆÂç∞Âà∑ÂèØËÉΩÈ´ò„ÅïÔºà‰ΩôÁôΩËÄÉÊÖÆÔºâ
            MAX_PAGES: 50                 // „É°„É¢„É™Âà∂Èôê„ÇíËÄÉÊÖÆ„Åó„ÅüÊúÄÂ§ß„Éö„Éº„Ç∏Êï∞
        };
        
        /**
         * ÊñáÂ≠óÊÉÖÂ†±„Å´„Éû„Éº„Ç´„Éº„ÇíÈÅ©Áî®
         * @param {string} char - ÊñáÂ≠ó
         * @param {number} index - ÊñáÂ≠ó‰ΩçÁΩÆ
         * @param {Array} markers - „Éû„Éº„Ç´„ÉºÈÖçÂàó
         * @returns {Object} ÊñáÂ≠óÊÉÖÂ†± {char, index, markerColor}
         */
        function applyMarkersToChar(char, index, markers) {
            let markerColor = null;
            
            // ÊúÄÊñ∞„ÅÆ„Éû„Éº„Ç´„Éº„ÇíÂÑ™ÂÖà
            for (let i = markers.length - 1; i >= 0; i--) {
                const marker = markers[i];
                if (index >= marker.start && index < marker.end) {
                    markerColor = marker.color === 'transparent' ? null : marker.color;
                    break;
                }
            }
            
            return { char, index, markerColor };
        }
        
        /**
         * „ÉÜ„Ç≠„Çπ„Éà„ÇíÊñáÂ≠óÊÉÖÂ†±ÈÖçÂàó„Å´Â§âÊèõ
         * @param {string} text - „ÉÜ„Ç≠„Çπ„Éà
         * @param {Array} markers - „Éû„Éº„Ç´„ÉºÈÖçÂàó
         * @returns {Array} ÊñáÂ≠óÊÉÖÂ†±ÈÖçÂàó
         */
        function parseTextWithMarkers(text, markers) {
            const charArray = [];
            
            for (let i = 0; i < text.length; i++) {
                const charInfo = applyMarkersToChar(text[i], i, markers);
                charArray.push(charInfo);
            }
            
            return charArray;
        }

        /**
         * ÊñáÂ≠óÊÉÖÂ†±ÈÖçÂàó„Çí„Éö„Éº„Ç∏„Å´ÂàÜÂâ≤
         * @param {Array} charArray - ÊñáÂ≠óÊÉÖÂ†±ÈÖçÂàó
         * @param {number} fontSize - „Éï„Ç©„É≥„Éà„Çµ„Ç§„Ç∫
         * @returns {Array} „Éö„Éº„Ç∏ÈÖçÂàó
         */
        function splitIntoPages(charArray, fontSize) {
            const pages = [];
            const fontSizeMM = fontSize * PRINT_CONSTANTS.PX_TO_MM;
            
            // 1Âàó„ÅÇ„Åü„Çä„ÅÆÊúÄÂ§ßÊñáÂ≠óÊï∞„Å®1„Éö„Éº„Ç∏„ÅÇ„Åü„Çä„ÅÆÊúÄÂ§ßÂàóÊï∞„ÇíË®àÁÆó
            const charsPerColumn = Math.floor(PRINT_CONSTANTS.PAGE_HEIGHT_MM / fontSizeMM);
            const columnWidthMM = fontSizeMM * (1 + PRINT_CONSTANTS.COLUMN_SPACING_RATIO);
            const columnsPerPage = Math.floor(PRINT_CONSTANTS.PAGE_WIDTH_MM / columnWidthMM);
            
            let currentPage = [];
            let currentColumn = [];
            let columnCount = 0;
            
            charArray.forEach((charInfo, index) => {
                // ÊîπË°åÂá¶ÁêÜ
                if (charInfo.char === '\n') {
                    if (currentColumn.length > 0) {
                        currentPage.push([...currentColumn]);
                        currentColumn = [];
                        columnCount++;
                        
                        if (columnCount >= columnsPerPage) {
                            pages.push([...currentPage]);
                            currentPage = [];
                            columnCount = 0;
                        }
                    }
                    
                    currentColumn.push(charInfo);
                    currentPage.push([...currentColumn]);
                    currentColumn = [];
                    columnCount++;
                    
                    if (columnCount >= columnsPerPage) {
                        pages.push([...currentPage]);
                        currentPage = [];
                        columnCount = 0;
                    }
                } else {
                    currentColumn.push(charInfo);
                    
                    if (currentColumn.length >= charsPerColumn) {
                        currentPage.push([...currentColumn]);
                        currentColumn = [];
                        columnCount++;
                        
                        if (columnCount >= columnsPerPage) {
                            pages.push([...currentPage]);
                            currentPage = [];
                            columnCount = 0;
                        }
                    }
                }
            });
            
            // ÊÆã„Çä„ÅÆÊñáÂ≠ó„ÇíÂá¶ÁêÜ
            if (currentColumn.length > 0) {
                if (columnCount >= columnsPerPage) {
                    if (currentPage.length > 0) {
                        pages.push([...currentPage]);
                    }
                    pages.push([currentColumn]);
                } else {
                    currentPage.push(currentColumn);
                }
            }
            
            if (currentPage.length > 0 && (currentColumn.length === 0 || columnCount < columnsPerPage)) {
                pages.push(currentPage);
            }
            
            return pages;
        }

        /**
         * „Éö„Éº„Ç∏„Åî„Å®„ÅÆHTML„ÇíÁîüÊàê
         * @param {Array} pageColumns - „Éö„Éº„Ç∏„ÅÆÂàóÈÖçÂàó
         * @param {Object} settings - Âç∞Âà∑Ë®≠ÂÆö
         * @returns {string} HTMLÊñáÂ≠óÂàó
         */
        function generatePageHTML(pageColumns, settings) {
            let html = '<div class="print-page">';
            
            pageColumns.forEach((column, columnIndex) => {
                const hasVisibleContent = column.some(charInfo => charInfo.char !== '\n');
                if (!hasVisibleContent) return;
                
                html += '<div class="print-column">';
                
                column.forEach(charInfo => {
                    if (charInfo.char === '\n') return;
                    
                    const escapedChar = escapeHtml(charInfo.char);
                    if (charInfo.markerColor) {
                        html += `<span class="char" style="background-color: ${charInfo.markerColor};">${escapedChar}</span>`;
                    } else {
                        html += `<span class="char">${escapedChar}</span>`;
                    }
                });
                
                html += '</div>';
            });
            
            html += '</div>';
            return html;
        }
        
        /**
         * Âç∞Âà∑Áî®HTML„Éâ„Ç≠„É•„É°„É≥„Éà„ÇíÁîüÊàê
         * @param {Array} pages - „Éö„Éº„Ç∏ÈÖçÂàó
         * @param {Object} settings - Âç∞Âà∑Ë®≠ÂÆö
         * @returns {string} ÂÆåÂÖ®„Å™HTMLÊñáÊõ∏
         */
        function createPrintDocument(pages, settings) {
            const { fontSize, fontFamily, textColor, alignment, isBlackboardMode } = settings;
            
            // ÊñáÂ≠óÊèÉ„Åà„ÅÆCSS„ÇíÁîüÊàê
            let alignmentStyle = '';
            let textAlignStyle = '';
            if (alignment === 'center') {
                alignmentStyle = 'align-items: center;';
                textAlignStyle = 'text-align: center;';
            } else if (alignment === 'right') {
                alignmentStyle = 'align-items: flex-end;';
                textAlignStyle = 'text-align: end;';
            } else {
                alignmentStyle = 'align-items: flex-start;';
                textAlignStyle = 'text-align: start;';
            }
            
            // „Éö„Éº„Ç∏HTML„ÇíÁîüÊàê
            let pagesHTML = '';
            pages.forEach((page, index) => {
                pagesHTML += generatePageHTML(page, settings);
                if (index < pages.length - 1) {
                    pagesHTML += '<div class="page-break"></div>';
                }
            });
            
            // ÂÆåÂÖ®„Å™Âç∞Âà∑Áî®HTML
            const printHTML = `
<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <!-- Âç∞Âà∑„Éâ„Ç≠„É•„É°„É≥„ÉàÁî®„ÅÆCSPË®≠ÂÆö -->
    <meta http-equiv="Content-Security-Policy" content="
        default-src 'self';
        style-src 'self' 'unsafe-inline' https://fonts.googleapis.com;
        font-src 'self' https://fonts.gstatic.com data:;
        img-src 'none';
        script-src 'none';
        connect-src 'none';
        object-src 'none';
        frame-src 'none';
        base-uri 'self';
        form-action 'none';
    ">
    
    <title>Âç∞Âà∑ - Á∏¶Êõ∏„Åç„É°„É¢ v1.8.0</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400&family=Noto+Serif+JP:wght@400;600&family=Klee+One:wght@400;600&display=swap');
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: ${fontFamily};
            color: ${textColor};
            background: white;
        }
        
        /* ËÉåÊôØËâ≤Âç∞Âà∑„ÇíÂº∑Âà∂ */
        * {
            -webkit-print-color-adjust: exact !important;
            print-color-adjust: exact !important;
            color-adjust: exact !important;
        }
        
        .print-page {
            width: 100%;
            height: 100vh;
            display: flex;
            flex-direction: row-reverse;
            ${alignmentStyle}
            padding: 15mm;
            box-sizing: border-box;
        }
        
        .print-column {
            writing-mode: vertical-rl;
            text-orientation: upright;
            margin-left: ${fontSize * 0.5}px;
            font-size: ${fontSize}px;
            line-height: 1;
            letter-spacing: 0;
            ${textAlignStyle}
        }
        
        .print-column:last-child {
            margin-left: 0;
        }
        
        .char {
            font-size: ${fontSize}px;
            line-height: 1;
            margin: 0;
            padding: 0;
            letter-spacing: 0;
        }
        
        .page-break {
            page-break-after: always;
            clear: both;
        }
        
        @media print {
            @page {
                size: A4 portrait;
                margin: 0;
            }
            
            body {
                margin: 0;
                background: white;
            }
            
            .print-page {
                width: 210mm;
                height: 297mm;
                max-width: 210mm;
                max-height: 297mm;
                page-break-inside: avoid;
                page-break-after: auto;
            }
            
            .char[style*="background-color"] {
                position: relative;
                z-index: 1;
            }
        }
    </style>
</head>
<body>
    ${pagesHTML}
</body>
</html>`;
            
            return printHTML;
        }
        
        /**
         * „Éö„Éº„Ç∏Êï∞„ÇíË¶ãÁ©ç„ÇÇ„Çã
         * @param {string} text - „ÉÜ„Ç≠„Çπ„Éà
         * @param {number} fontSize - „Éï„Ç©„É≥„Éà„Çµ„Ç§„Ç∫
         * @returns {number} Êé®ÂÆö„Éö„Éº„Ç∏Êï∞
         */
        function estimatePageCount(text, fontSize) {
            if (!text) return 0;
            
            const fontSizeMM = fontSize * PRINT_CONSTANTS.PX_TO_MM;
            const charsPerColumn = Math.floor(PRINT_CONSTANTS.PAGE_HEIGHT_MM / fontSizeMM);
            const columnWidthMM = fontSizeMM * (1 + PRINT_CONSTANTS.COLUMN_SPACING_RATIO);
            const columnsPerPage = Math.floor(PRINT_CONSTANTS.PAGE_WIDTH_MM / columnWidthMM);
            
            const lines = text.split('\n');
            let totalColumns = 0;
            
            lines.forEach(line => {
                if (line.length === 0) {
                    totalColumns++; // Á©∫Ë°å„ÇÇ1Âàó„Å®„Åó„Å¶Êï∞„Åà„Çã
                } else {
                    totalColumns += Math.ceil(line.length / charsPerColumn);
                }
            });
            
            return Math.ceil(totalColumns / columnsPerPage);
        }
        
        /**
         * „É°„Ç§„É≥Âç∞Âà∑Èñ¢Êï∞
         * ÂêÑÁ®ÆÊ§úË®º„Å®„É¶„Éº„Ç∂„ÉºÁ¢∫Ë™ç„ÇíË°å„ÅÜ
         */
        function printWithMarkers() {
            try {
                const text = textInput.value;
                if (!text) {
                    alert('Âç∞Âà∑„Åô„Çã„ÉÜ„Ç≠„Çπ„Éà„Åå„ÅÇ„Çä„Åæ„Åõ„Çì');
                    return;
                }
                
                const fontSize = parseInt(fontSizeSelector.value);
                const textColor = textColorSelector.value;
                const isBlackboardMode = blackboardToggle.checked;
                
                // „Éö„Éº„Ç∏Êï∞„ÉÅ„Çß„ÉÉ„ÇØ
                const estimatedPages = estimatePageCount(text, fontSize);
                if (estimatedPages > 30) {
                    if (!confirm(`Á¥Ñ${estimatedPages}„Éö„Éº„Ç∏„Å´„Å™„Çä„Åæ„Åô„ÄÇ\n\nÁ∂ôÁ∂ö„Åó„Åæ„Åô„ÅãÔºü`)) {
                        return;
                    }
                }

                if (estimatedPages > PRINT_CONSTANTS.MAX_PAGES) {
                    alert(`„Éö„Éº„Ç∏Êï∞„ÅåÂ§ö„Åô„Åé„Åæ„ÅôÔºà${estimatedPages}„Éö„Éº„Ç∏Ôºâ„ÄÇ\nÊúÄÂ§ß${PRINT_CONSTANTS.MAX_PAGES}„Éö„Éº„Ç∏„Åæ„Åß„Å®„Å™„Çä„Åæ„Åô„ÄÇ`);
                    return;
                }

                // Âç∞Âà∑Âà∂Èôê„ÅÆË≠¶Âëä
                if (fontSize >= 16) {
                    if (!confirm(`Á∞°ÊòìÂç∞Âà∑Ê©üËÉΩ„ÅÆ„Åü„ÇÅ‰∏ÄÈÉ®„ÅÆÊñáÂ≠ó„ÅåÂç∞Âà∑„Åï„Çå„Å™„ÅÑÂ†¥Âêà„Åå„ÅÇ„Çä„Åæ„Åô„ÄÇ\nÊ≠£Á¢∫„Å™Âç∞Âà∑„Å´„ÅØ‰øùÂ≠òÊ∏à„ÅøSVG„Éï„Ç°„Ç§„É´„ÅÆÁõ¥Êé•Âç∞Âà∑„Çí„ÅîÊ§úË®é„Åè„Å†„Åï„ÅÑ„ÄÇ\n\nÁ∂ôÁ∂ö„Åó„Åæ„Åô„ÅãÔºü`)) {
                        return;
                    }
                }

                // ÈªíÊùø„É¢„Éº„ÉâÊôÇ„ÅÆÁ¢∫Ë™ç
                if (isBlackboardMode) {
                    if (!confirm('ÈªíÊùø„É¢„Éº„Éâ„ÅØÂç∞Âà∑ÊôÇ„Å´ÁôΩËÉåÊôØ„Å´Â§âÊõ¥„Åï„Çå„Åæ„Åô„ÄÇ\n\nÁ∂ôÁ∂ö„Åó„Åæ„Åô„ÅãÔºü')) {
                        return;
                    }
                }
                
                // ÁôΩÊñáÂ≠ó„ÅÆÁ¢∫Ë™ç
                if (textColor == '#FFFFFF') {
                    if (!confirm('ÁôΩÊñáÂ≠ó„ÅØÁôΩ„ÅÑÁ¥ô„Å´Âç∞Âà∑„Åß„Åç„Åæ„Åõ„Çì\n\nÁ∂ôÁ∂ö„Åó„Åæ„Åô„ÅãÔºü')) {
                        return;
                    }
                }
                
                executePrint(text, fontSize);
                
            } catch (error) {
                console.error('Âç∞Âà∑„Ç®„É©„Éº:', error);
                alert('Âç∞Âà∑Âá¶ÁêÜ‰∏≠„Å´„Ç®„É©„Éº„ÅåÁô∫Áîü„Åó„Åæ„Åó„Åü„ÄÇ');
            }
        }
        
        /**
         * Âç∞Âà∑ÂÆüË°åÈñ¢Êï∞
         * @param {string} text - Âç∞Âà∑„Åô„Çã„ÉÜ„Ç≠„Çπ„Éà
         * @param {number} fontSize - „Éï„Ç©„É≥„Éà„Çµ„Ç§„Ç∫
         */
        function executePrint(text, fontSize) {
            // ÊñáÂ≠óÊÉÖÂ†±ÈÖçÂàó„ÇíÁîüÊàê
            const charArray = parseTextWithMarkers(text, markerState.markers);
            
            // „Éö„Éº„Ç∏ÂàÜÂâ≤
            const pages = splitIntoPages(charArray, fontSize);
            
            // Âç∞Âà∑Áî®HTMLÁîüÊàê
            const printHTML = createPrintDocument(pages, {
                fontSize: fontSize,
                fontFamily: fontSelector.value,
                textColor: textColorSelector.value,
                alignment: alignmentSelector.value,
                isBlackboardMode: false // Âç∞Âà∑ÊôÇ„ÅØÂ∏∏„Å´ÁôΩËÉåÊôØ
            });
            
            // ÈùûË°®Á§∫„ÅÆiframe„Çí‰ΩúÊàê
            const printFrame = document.createElement('iframe');
            printFrame.style.display = 'none';
            document.body.appendChild(printFrame);
            
            const printDocument = printFrame.contentWindow.document;
            
            printDocument.open();
            printDocument.write(printHTML);
            printDocument.close();
            
            // „Éï„Ç©„É≥„Éà„ÅÆË™≠„ÅøËæº„Åø„ÇíÂæÖ„Å£„Å¶„Åã„ÇâÂç∞Âà∑
            setTimeout(() => {
                printFrame.contentWindow.focus();
                printFrame.contentWindow.print();
                
                // Âç∞Âà∑„ÉÄ„Ç§„Ç¢„É≠„Ç∞„ÅåÈñâ„Åò„Çâ„Çå„ÅüÂæå„Å´iframe„ÇíÂâäÈô§
                setTimeout(() => {
                    document.body.removeChild(printFrame);
                }, 1000);
            }, 500);
        }
        
        printButton.addEventListener('click', printWithMarkers);

        // === SVGË™≠ËæºÊ©üËÉΩ ===
        loadButton.addEventListener('click', () => {
            svgLoadInput.click();
        });

        svgLoadInput.addEventListener('change', (event) => {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = (e) => {
                const svgContent = e.target.result;
                try {
                    const parser = new DOMParser();
                    const svgDoc = parser.parseFromString(svgContent, "image/svg+xml");

                    if (svgDoc.getElementsByTagName("parsererror").length > 0) throw new Error("SVG„Éï„Ç°„Ç§„É´„ÅÆËß£Êûê„Å´Â§±Êïó„Åó„Åæ„Åó„Åü„ÄÇ");
                    
                    // „ÉÜ„Ç≠„Çπ„Éà„ÅÆË™≠„ÅøËæº„Åø
                    const textElements = svgDoc.querySelectorAll('text');
                    if (textElements.length === 0) throw new Error("SVGÂÜÖ„Å´„ÉÜ„Ç≠„Çπ„Éà„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì„Åß„Åó„Åü„ÄÇ");
                    
                    const lines = [];
                    textElements.forEach(textEl => {
                        lines.push({ x: parseFloat(textEl.getAttribute('x')), content: textEl.textContent || "" });
                    });

                    lines.sort((a, b) => b.x - a.x);
                    const loadedText = lines.map(line => line.content).join('\n');
                    
                    textInput.value = loadedText;
                    
                    // ÊñáÂ≠óËâ≤„ÅÆÂæ©ÂÖÉ
                    const textColorElement = svgDoc.querySelector('metadata textColor');
                    if (textColorElement) {
                        const savedColor = textColorElement.textContent;
                        for (let i = 0; i < textColorSelector.options.length; i++) {
                            if (textColorSelector.options[i].value === savedColor) {
                                textColorSelector.selectedIndex = i;
                                applyTextColor(savedColor);
                                updateColorPreview();
                                break;
                            }
                        }
                    }
                    
                    // „Éû„Éº„Ç´„ÉºÊÉÖÂ†±„ÅÆÂæ©ÂÖÉ
                    markerState.markers = [];
                    markerState.markerId = 0;
                    
                    const markerElements = svgDoc.querySelectorAll('metadata markers marker');
                    if (markerElements.length > 0) {
                        markerElements.forEach(markerEl => {
                            const marker = {
                                id: parseInt(markerEl.getAttribute('id')),
                                start: parseInt(markerEl.getAttribute('start')),
                                end: parseInt(markerEl.getAttribute('end')),
                                color: markerEl.getAttribute('color')
                            };
                            
                            // „ÉÜ„Ç≠„Çπ„ÉàÁØÑÂõ≤„ÅÆÊ§úË®º
                            if (marker.start >= 0 && marker.end <= loadedText.length && marker.start < marker.end) {
                                marker.text = loadedText.substring(marker.start, marker.end);
                                markerState.markers.push(marker);
                                markerState.markerId = Math.max(markerState.markerId, marker.id);
                            }
                        });
                        
                        console.log(`${markerState.markers.length}ÂÄã„ÅÆ„Éû„Éº„Ç´„Éº„ÇíÂæ©ÂÖÉ„Åó„Åæ„Åó„Åü„ÄÇ(v${APP_INFO.version})`);
                    }
                    
                    // ÈªíÊùø„É¢„Éº„Éâ„ÅÆÂæ©ÂÖÉ
                    const blackboardModeElement = svgDoc.querySelector('metadata blackboardMode');
                    if (blackboardModeElement && blackboardModeElement.textContent === 'true') {
                        blackboardToggle.checked = true;
                        document.body.classList.add('blackboard-mode');
                    } else {
                        blackboardToggle.checked = false;
                        document.body.classList.remove('blackboard-mode');
                    }
                    
                    updatePreviewWithMarkers();
                    console.log(`SVG„Éï„Ç°„Ç§„É´„ÇíÊ≠£Â∏∏„Å´Ë™≠„ÅøËæº„Åø„Åæ„Åó„Åü„ÄÇ(„Ç¢„Éó„É™„Éê„Éº„Ç∏„Éß„É≥: v${APP_INFO.version})`);

                } catch (error) {
                    console.error('SVGË™≠Ëæº„Ç®„É©„Éº:', error);
                    showButtonError(loadButton, error.message);
                } finally {
                    svgLoadInput.value = '';
                }
            };
            reader.onerror = () => {
                console.error("„Éï„Ç°„Ç§„É´„ÅÆË™≠„ÅøËæº„Åø„Å´Â§±Êïó„Åó„Åæ„Åó„Åü„ÄÇ");
            };
            reader.readAsText(file);
        });

        // === „Çø„ÉÉ„ÉÅÊìç‰Ωú„ÅÆÊúÄÈÅ©Âåñ ===
        if ('ontouchstart' in window) {
            textInput.style.touchAction = 'pan-y';
            previewArea.style.touchAction = 'pan-y';
        }

        // === „Çπ„ÇØ„É≠„Éº„É´ÂêåÊúüÊ©üËÉΩ ===
        
        /**
         * „Çπ„ÇØ„É≠„Éº„É´‰ΩçÁΩÆ„ÇíÂêåÊúü
         * @param {HTMLElement} source - „Çπ„ÇØ„É≠„Éº„É´ÂÖÉ
         * @param {HTMLElement} target - „Çπ„ÇØ„É≠„Éº„É´ÂÖà
         * 
         * AI-NOTE: Á∏¶Êõ∏„Åç„Å™„ÅÆ„ÅßÊ®™„Çπ„ÇØ„É≠„Éº„É´„ÅÆ„Åø„ÇíÂêåÊúü
         */
        function syncScroll(source, target) {
            if (!scrollSyncState.isEnabled || !togglePreview.checked || scrollSyncState.temporaryDisabled) return;
            
            if (scrollSyncState.isSyncing) return;
            
            scrollSyncState.isSyncing = true;
            
            // Á∏¶Êõ∏„Åç„Å™„ÅÆ„ÅßÊ®™„Çπ„ÇØ„É≠„Éº„É´„ÅÆ„Åø„ÇíÂêåÊúü
            const sourceScrollRatio = source.scrollLeft / (source.scrollWidth - source.clientWidth);
            const targetScrollLeft = sourceScrollRatio * (target.scrollWidth - target.clientWidth);
            
            // „Çπ„É†„Éº„Ç∫„Å™„Çπ„ÇØ„É≠„Éº„É´„Ç¢„Éã„É°„Éº„Ç∑„Éß„É≥
            if (scrollSyncState.syncAnimationId) {
                cancelAnimationFrame(scrollSyncState.syncAnimationId);
            }
            
            scrollSyncState.syncAnimationId = requestAnimationFrame(() => {
                target.scrollLeft = targetScrollLeft;
                
                setTimeout(() => {
                    scrollSyncState.isSyncing = false;
                }, 50);
            });
        }

        // „Çπ„ÇØ„É≠„Éº„É´„Ç§„Éô„É≥„Éà„ÅÆ„Éá„Éê„Ç¶„É≥„ÇπÂá¶ÁêÜ
        let scrollDebounceTimer = null;
        function debounceScroll(func, wait) {
            return function(event) {
                if (scrollDebounceTimer) clearTimeout(scrollDebounceTimer);
                scrollDebounceTimer = setTimeout(() => {
                    func(event);
                }, wait);
            };
        }

        const handleTextInputScroll = debounceScroll(() => {
            syncScroll(textInput, previewArea);
        }, 10);

        const handlePreviewAreaScroll = debounceScroll(() => {
            syncScroll(previewArea, textInput);
        }, 10);

        /**
         * „Çπ„ÇØ„É≠„Éº„É´„Ç§„Éô„É≥„Éà„É™„Çπ„Éä„Éº„ÅÆÁôªÈå≤„ÉªËß£Èô§„ÇíÁÆ°ÁêÜ
         */
        function setupScrollSync() {
            if (togglePreview.checked && scrollSyncState.isEnabled) {
                textInput.addEventListener('scroll', handleTextInputScroll);
                previewArea.addEventListener('scroll', handlePreviewAreaScroll);
            } else {
                textInput.removeEventListener('scroll', handleTextInputScroll);
                previewArea.removeEventListener('scroll', handlePreviewAreaScroll);
            }
        }

        setupScrollSync();

        // „Çπ„ÇØ„É≠„Éº„É´ÂêåÊúü„Éà„Ç∞„É´„ÅÆ„Ç§„Éô„É≥„Éà„É™„Çπ„Éä„Éº
        scrollSyncToggle.addEventListener('change', (e) => {
            scrollSyncState.isEnabled = e.target.checked;
            setupScrollSync();
            if (scrollSyncState.isEnabled && togglePreview.checked) {
                // ÂêåÊúü„ÇíÊúâÂäπ„Å´„Åó„Åü„Çâ„ÄÅÁèæÂú®„ÅÆ„Çπ„ÇØ„É≠„Éº„É´‰ΩçÁΩÆ„ÇíÂêåÊúü
                syncScroll(textInput, previewArea);
            }
        });
          
        // === PWAÊ©üËÉΩ„ÅÆÂÆüË£Ö ===

        // Service WorkerÁôªÈå≤
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/tategaki-memo-pwa/service-worker.js')
                    .then((registration) => {
                        console.log('Service Worker registered:', registration);
                        
                        // Êõ¥Êñ∞„ÉÅ„Çß„ÉÉ„ÇØ
                        registration.addEventListener('updatefound', () => {
                            const newWorker = registration.installing;
                            newWorker.addEventListener('statechange', () => {
                                if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
                                    // Êñ∞„Åó„ÅÑ„Éê„Éº„Ç∏„Éß„É≥„ÅåÂà©Áî®ÂèØËÉΩ
                                    showUpdateNotification();
                                }
                            });
                        });
                    })
                    .catch((error) => {
                        console.error('Service Worker registration failed:', error);
                    });
            });
        }

        // „Ç§„É≥„Çπ„Éà„Éº„É´„Éó„É≠„É≥„Éó„Éà
        let deferredPrompt;
        const installButton = document.createElement('button');
        installButton.innerHTML = '„Ç¢„Éó„É™„Çí„Ç§„É≥„Çπ„Éà„Éº„É´';
        installButton.className = 'dynamic-button bg-green-700 text-white font-bold rounded-lg hover:bg-green-800 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500 transition-transform transform hover:scale-105 touch-target hidden';
        installButton.style.marginRight = '12px';

        // „Ç§„É≥„Çπ„Éà„Éº„É´„Éú„Çø„É≥„ÇíÊìç‰Ωú„Éê„Éº„Å´ËøΩÂä†
        const operationBar = document.querySelector('.bg-gray-50.dynamic-p-3');
        const buttonContainer = operationBar.querySelector('.flex.items-center.dynamic-gap-3.flex-wrap').lastElementChild;
        buttonContainer.insertBefore(installButton, buttonContainer.firstChild);

        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            deferredPrompt = e;
            installButton.classList.remove('hidden');
        });

        installButton.addEventListener('click', async () => {
            if (!deferredPrompt) return;
            
            deferredPrompt.prompt();
            const { outcome } = await deferredPrompt.userChoice;
            console.log(`User response to install prompt: ${outcome}`);
            
            if (outcome === 'accepted') {
                installButton.classList.add('hidden');
            }
            deferredPrompt = null;
        });

        // „Ç§„É≥„Çπ„Éà„Éº„É´ÂÆå‰∫Ü„ÅÆÊ§úÁü•
        window.addEventListener('appinstalled', () => {
            console.log('PWA was installed');
            installButton.classList.add('hidden');
        });

        // Êõ¥Êñ∞ÈÄöÁü•„ÅÆË°®Á§∫
        function showUpdateNotification() {
            const notification = document.createElement('div');
            notification.className = 'fixed bottom-4 right-4 bg-indigo-600 text-white p-4 rounded-lg shadow-lg z-50';
            notification.innerHTML = `
                <p class="mb-2">Êñ∞„Åó„ÅÑ„Éê„Éº„Ç∏„Éß„É≥„ÅåÂà©Áî®ÂèØËÉΩ„Åß„Åô</p>
                <button onclick="updateServiceWorker()" class="bg-white text-indigo-600 px-3 py-1 rounded font-medium">
                    Êõ¥Êñ∞„Åô„Çã
                </button>
            `;
            document.body.appendChild(notification);
            
            setTimeout(() => {
                if (notification.parentNode) {
                    notification.remove();
                }
            }, 10000);
        }

        // „Ç™„É≥„É©„Ç§„É≥/„Ç™„Éï„É©„Ç§„É≥Áä∂ÊÖã„ÅÆÁõ£Ë¶ñ
        function updateOnlineStatus() {
            const statusIndicator = document.createElement('div');
            statusIndicator.className = 'fixed top-4 right-4 px-3 py-1 rounded-full text-sm font-medium z-50';
            
            if (navigator.onLine) {
                statusIndicator.classList.add('bg-green-100', 'text-green-800');
                statusIndicator.textContent = '„Ç™„É≥„É©„Ç§„É≥';
                setTimeout(() => statusIndicator.remove(), 3000);
            } else {
                statusIndicator.classList.add('bg-red-100', 'text-red-800');
                statusIndicator.textContent = '„Ç™„Éï„É©„Ç§„É≥';
            }
            
            if (!document.querySelector('.fixed.top-4.right-4')) {
                document.body.appendChild(statusIndicator);
            }
        }

        window.addEventListener('online', updateOnlineStatus);
        window.addEventListener('offline', updateOnlineStatus);

        // „Éê„ÉÉ„ÇØ„Ç∞„É©„Ç¶„É≥„ÉâÂêåÊúü„ÅÆÁôªÈå≤
        async function registerBackgroundSync() {
            if ('serviceWorker' in navigator && 'sync' in ServiceWorkerRegistration.prototype) {
                try {
                    const registration = await navigator.serviceWorker.ready;
                    await registration.sync.register('sync-saved-files');
                    console.log('Background sync registered');
                } catch (error) {
                    console.error('Background sync registration failed:', error);
                }
            }
        }

        // ÂÖ±Êúâ„Çø„Éº„Ç≤„ÉÉ„Éà„ÅÆÂá¶ÁêÜ
        const urlParams = new URLSearchParams(window.location.search);
        const sharedText = urlParams.get('text');
        if (sharedText) {
            textInput.value = sharedText;
            updatePreviewWithMarkers();
            // URL„Éë„É©„É°„Éº„Çø„Çí„ÇØ„É™„Ç¢
            window.history.replaceState({}, document.title, window.location.pathname);
        }

        // „Éö„Éº„Ç∏Èõ¢ËÑ±ÊôÇ„ÅÆË≠¶ÂëäÔºàÊú™‰øùÂ≠ò„ÅÆÂ§âÊõ¥„Åå„ÅÇ„ÇãÂ†¥ÂêàÔºâ
        let hasUnsavedChanges = false;
        textInput.addEventListener('input', () => {
            hasUnsavedChanges = true;
        });

        window.addEventListener('beforeunload', (e) => {
            if (hasUnsavedChanges) {
                e.preventDefault();
                e.returnValue = '';
            }
        });

        // ‰øùÂ≠òÊôÇ„Å´Êú™‰øùÂ≠ò„Éï„É©„Ç∞„Çí„ÇØ„É™„Ç¢
        const originalSaveButtonClick = saveButton.onclick;
        saveButton.onclick = function() {
            if (originalSaveButtonClick) originalSaveButtonClick.apply(this, arguments);
            hasUnsavedChanges = false;
        };

        // PWA„Å®„Åó„Å¶„ÅÆËµ∑Âãï„ÇíÊ§úÁü•
        if (window.matchMedia('(display-mode: standalone)').matches) {
            console.log('Running as PWA');
            document.body.classList.add('pwa-mode');
        }

        // Ëµ∑ÂãïÊôÇ„ÅÆ„Çπ„Éó„É©„ÉÉ„Ç∑„É•„Çπ„ÇØ„É™„Éº„É≥ÂäπÊûú
        document.addEventListener('DOMContentLoaded', () => {
            document.body.style.opacity = '0';
            document.body.style.transition = 'opacity 0.3s ease-in';
            setTimeout(() => {
                document.body.style.opacity = '1';
            }, 100);
        });
          
        }); // DOMContentLoadedÁµÇ‰∫Ü
    </script>
</body>
</html>
